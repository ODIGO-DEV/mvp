{% extends "dashboard/base.html" %}
{% block title %}{{ recipe.name }} - ODiGO{% endblock %}
{% block extra_head %}
<style>
    .recipe-hero-gradient {
        background: linear-gradient(135deg, rgba(79, 70, 229, 0.95) 0%, rgba(147, 51, 234, 0.95) 100%);
    }

    .ingredient-item:hover {
        transform: translateX(4px);
        transition: all 0.2s ease;
    }

    .step-card {
        transition: all 0.3s ease;
    }

    .step-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(79, 70, 229, 0.08);
    }

    .step-card.completed {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.03) 0%, rgba(21, 128, 61, 0.03) 100%);
        border-color: #22c55e;
    }

    .step-number-circle.completed {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }

    .image-gallery img {
        transition: all 0.3s ease;
    }

    .image-gallery img:hover {
        transform: scale(1.05);
    }

    .floating-action-btn {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 50;
    }

    @media (max-width: 768px) {
        .floating-action-btn {
            bottom: 1rem;
            right: 1rem;
        }
    }

    .ingredient-item.checked {
        opacity: 0.6;
        background-color: #f9fafb;
    }

    .ingredient-item.checked label {
        text-decoration: line-through;
    }

    /* Enhanced Header Styles */
    .action-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        color: #4B5563;
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
    }

    .action-button:hover {
        color: #4F46E5;
        background-color: #EEF2FF;
    }

    .action-button-primary {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background-color: #4F46E5;
        color: white;
        font-weight: 500;
        border-radius: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease-in-out;
    }

    .action-button-primary:hover {
        background-color: #4338CA;
    }

    .action-text {
        font-size: 0.875rem;
    }

    .mobile-action-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
        padding: 0.75rem;
        color: #4B5563;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
        text-decoration: none;
    }

    .mobile-action-button:hover {
        color: #4F46E5;
        background-color: #EEF2FF;
    }

    /* Hero Action Buttons */
    .hero-action-btn {
        background-color: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(8px);
        color: white;
        padding: 0.5rem;
        border-radius: 9999px;
        transition: all 0.2s ease-in-out;
    }

    .hero-action-btn:hover {
        background-color: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }

    /* Stats Cards */
    .stat-card {
        background-color: #F9FAFB;
        border-radius: 0.75rem;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        transition: background-color 0.2s ease-in-out;
    }

    .stat-card:hover {
        background-color: #F3F4F6;
    }

    .stat-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
        flex-shrink: 0;
    }

    .stat-content {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        font-size: 1.125rem;
        font-weight: 700;
        color: #111827;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6B7280;
        font-weight: 500;
    }

    /* Recipe Tags */
    .recipe-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid;
    }

    /* Improved Mobile Responsiveness */
    @media (max-width: 768px) {
        .hero-action-btn {
            padding: 0.75rem;
        }

        .stat-card {
            padding: 0.75rem;
        }

        .stat-icon {
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1rem;
        }

        .stat-value {
            font-size: 1rem;
        }

        .stat-label {
            font-size: 0.75rem;
        }
    }

    /* Image Gallery Enhancements */
    .image-gallery img {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .image-gallery .group:hover img {
        transform: scale(1.05);
    }

    /* Animation for mobile menu */
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #mobileMenu:not(.hidden) {
        animation: slideDown 0.2s ease-out;
    }
</style>
{% endblock %}
{% block dashboard_content %}
<div class="min-h-screen bg-gray-50 pb-20">
    <!-- Enhanced Navigation Header -->
    <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <!-- Left Section - Navigation -->
                <div class="flex items-center gap-4">
                    <button onclick="history.back()"
                        class="inline-flex items-center gap-2 text-gray-600 hover:text-indigo-600 transition-all duration-200 font-medium bg-gray-50 hover:bg-indigo-50 px-3 py-2 rounded-lg">
                        <i class="fas fa-arrow-left"></i>
                        <span class="hidden sm:inline">Back to Recipes</span>
                        <span class="sm:hidden">Back</span>
                    </button>
                    <!-- Breadcrumb -->
                    <div class="hidden md:flex items-center text-sm text-gray-500">
                        <a href="{{ url_for('dashboard.explore') }}"
                            class="hover:text-indigo-600 transition-colors">Recipes</a>
                        <i class="fas fa-chevron-right mx-2 text-xs"></i>
                        <span class="text-gray-900 font-medium truncate max-w-32">{{ recipe.name }}</span>
                    </div>
                </div>

                <!-- Right Section - Actions -->
                <div class="flex items-center gap-2">
                    <!-- Mobile Menu Button -->
                    <button id="mobileMenuBtn"
                        class="md:hidden p-2 text-gray-600 hover:text-indigo-600 transition-colors rounded-lg hover:bg-gray-50"
                        title="More Options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>

                    <!-- Desktop Actions -->
                    <div class="hidden md:flex items-center gap-2">
                        <button class="action-button" title="Add to Favorites" onclick="toggleFavorite()">
                            <i class="far fa-heart"></i>
                            <span class="action-text">Favorite</span>
                        </button>
                        <button class="action-button" title="Share Recipe" onclick="shareRecipe()">
                            <i class="fas fa-share-alt"></i>
                            <span class="action-text">Share</span>
                        </button>
                        <button class="action-button" title="Print Recipe" onclick="printRecipe()">
                            <i class="fas fa-print"></i>
                            <span class="action-text">Print</span>
                        </button>
                        <a href="{{ url_for('dashboard.edit_recipe', recipe_id=recipe.id) }}"
                            class="action-button-primary" title="Edit Recipe">
                            <i class="fas fa-edit"></i>
                            <span class="action-text">Edit</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Dropdown Menu -->
        <div id="mobileMenu" class="hidden md:hidden border-t border-gray-200 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="grid grid-cols-2 gap-2">
                    <button class="mobile-action-button" onclick="toggleFavorite()">
                        <i class="far fa-heart"></i>
                        <span>Favorite</span>
                    </button>
                    <button class="mobile-action-button" onclick="shareRecipe()">
                        <i class="fas fa-share-alt"></i>
                        <span>Share</span>
                    </button>
                    <button class="mobile-action-button" onclick="printRecipe()">
                        <i class="fas fa-print"></i>
                        <span>Print</span>
                    </button>
                    <a href="{{ url_for('dashboard.edit_recipe', recipe_id=recipe.id) }}" class="mobile-action-button">
                        <i class="fas fa-edit"></i>
                        <span>Edit</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 max-w-7xl">
        <!-- Enhanced Hero Section with Image Gallery -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden my-6">
            {% if recipe.images %}
            <div class="relative h-72 md:h-96 lg:h-[28rem]">
                <!-- Main Image Gallery Grid -->
                <div class="image-gallery grid grid-cols-1 md:grid-cols-3 gap-2 h-full p-2">
                    <!-- Main Large Image -->
                    <div class="md:col-span-2 relative overflow-hidden rounded-xl cursor-pointer group"
                        onclick="openImageModal('{{ recipe.images[0].url }}')">
                        <img src="{{ recipe.images[0].url }}" alt="{{ recipe.name }}"
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                        <div
                            class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        </div>
                        <div class="absolute top-4 left-4">
                            <span
                                class="bg-black/30 backdrop-blur-sm text-white px-3 py-1 rounded-full text-sm font-medium">
                                <i class="fas fa-camera mr-1"></i>
                                {{ recipe.images|length }} Photo{{ 's' if recipe.images|length > 1 }}
                            </span>
                        </div>
                        <div
                            class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <div class="bg-white/20 backdrop-blur-sm p-3 rounded-full">
                                <i class="fas fa-expand text-white text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Side Images Grid -->
                    <div class="hidden md:flex flex-col gap-2">
                        {% if recipe.images|length >= 2 %}
                        <div class="flex-1 relative overflow-hidden rounded-xl cursor-pointer group"
                            onclick="openImageModal('{{ recipe.images[1].url }}')">
                            <img src="{{ recipe.images[1].url }}" alt="{{ recipe.name }}"
                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            <div
                                class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            </div>
                        </div>
                        {% endif %}

                        {% if recipe.images|length >= 3 %}
                        <div class="flex-1 relative overflow-hidden rounded-xl cursor-pointer group"
                            onclick="{% if recipe.images|length > 3 %}showImageGallery(){% else %}openImageModal('{{ recipe.images[2].url }}'){% endif %}">
                            <img src="{{ recipe.images[2].url }}" alt="{{ recipe.name }}"
                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            {% if recipe.images|length > 3 %}
                            <div
                                class="absolute inset-0 bg-black/60 flex items-center justify-center group-hover:bg-black/70 transition-colors">
                                <div class="text-center text-white">
                                    <i class="fas fa-images text-2xl mb-2"></i>
                                    <p class="text-sm font-semibold">+{{ recipe.images|length - 3 }} More</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if recipe.images|length < 3 %} <div
                            class="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl flex items-center justify-center">
                            <div class="text-center text-gray-400">
                                <i class="fas fa-camera text-2xl mb-2"></i>
                                <p class="text-sm">Add more photos</p>
                            </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Enhanced Recipe Title Overlay -->
            <div
                class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent p-6">
                <div class="max-w-4xl">
                    <!-- Recipe Meta -->
                    <div class="flex flex-wrap items-center gap-3 mb-3">
                        {% if recipe.category %}
                        <span class="bg-indigo-600 text-white px-3 py-1 rounded-full text-sm font-medium">
                            {{ recipe.category.name }}
                        </span>
                        {% endif %}
                        <div class="flex items-center text-white/80 text-sm">
                            <i class="fas fa-clock mr-1"></i>
                            <span>45 min</span>
                        </div>
                        <div class="flex items-center text-white/80 text-sm">
                            <i class="fas fa-users mr-1"></i>
                            <span>4 servings</span>
                        </div>
                        <div class="flex items-center text-white/80 text-sm">
                            <i class="fas fa-signal mr-1"></i>
                            <span>Medium</span>
                        </div>
                    </div>

                    <!-- Recipe Title -->
                    <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-3 leading-tight">
                        {{ recipe.name }}
                    </h1>

                    <!-- Author and Rating -->
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <div class="flex items-center">
                                <div
                                    class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-white font-bold">{{ (recipe.author.name or 'A')[0].upper()
                                        }}</span>
                                </div>
                                <div>
                                    <p class="text-white font-semibold">{{ recipe.author.name or 'Anonymous Chef' }}</p>
                                    <p class="text-white/60 text-sm">{{ recipe.created_at.strftime('%B %d, %Y') }}</p>
                                </div>
                            </div>

                            <!-- Rating -->
                            <div class="flex items-center gap-2">
                                <div class="flex text-yellow-400">
                                    {% for i in range(5) %}
                                    <i class="fas fa-star text-sm"></i>
                                    {% endfor %}
                                </div>
                                <span class="text-white text-sm font-medium">(4.8)</span>
                                <span class="text-white/60 text-sm">124 reviews</span>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="flex items-center gap-2">
                            <button class="hero-action-btn" onclick="toggleFavorite()" title="Add to Favorites">
                                <i class="far fa-heart"></i>
                            </button>
                            <button class="hero-action-btn" onclick="shareRecipe()" title="Share Recipe">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Fallback for recipes without images -->
        <div
            class="relative h-64 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 flex items-center justify-center">
            <div class="text-center text-white">
                <i class="fas fa-utensils text-6xl mb-4 opacity-50"></i>
                <h1 class="text-4xl font-bold mb-2">{{ recipe.name }}</h1>
                <p class="text-white/80">by {{ recipe.author.name or 'Anonymous Chef' }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Recipe Description and Stats -->
        <div class="p-6">
            {% if recipe.description %}
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-3">About This Recipe</h2>
                <p class="text-gray-700 leading-relaxed text-lg">{{ recipe.description }}</p>
            </div>
            {% endif %}

            <!-- Enhanced Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card">
                    <div class="stat-icon bg-blue-100 text-blue-600">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value">45 min</span>
                        <span class="stat-label">Total Time</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon bg-green-100 text-green-600">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value">4</span>
                        <span class="stat-label">Servings</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon bg-orange-100 text-orange-600">
                        <i class="fas fa-signal"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value">Medium</span>
                        <span class="stat-label">Difficulty</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon bg-purple-100 text-purple-600">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-value">320</span>
                        <span class="stat-label">Calories</span>
                    </div>
                </div>
            </div>

            <!-- Recipe Tags -->
            {% if recipe.category or recipe.origin %}
            <div class="mt-6 pt-6 border-t border-gray-100">
                <h3 class="text-sm font-medium text-gray-900 mb-3">Tags</h3>
                <div class="flex flex-wrap gap-2">
                    {% if recipe.category %}
                    <span class="recipe-tag bg-indigo-50 text-indigo-700 border-indigo-200">
                        <i class="fas fa-tag mr-1"></i>
                        {{ recipe.category.name }}
                    </span>
                    {% endif %}
                    {% if recipe.origin %}
                    <span class="recipe-tag bg-green-50 text-green-700 border-green-200">
                        <i class="fas fa-globe mr-1"></i>
                        {{ recipe.origin.name }}
                    </span>
                    {% endif %}
                    <span class="recipe-tag bg-yellow-50 text-yellow-700 border-yellow-200">
                        <i class="fas fa-leaf mr-1"></i>
                        Healthy
                    </span>
                    <span class="recipe-tag bg-red-50 text-red-700 border-red-200">
                        <i class="fas fa-pepper-hot mr-1"></i>
                        Spicy
                    </span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Ingredients Sidebar -->
        <div class="lg:col-span-4">
            <div class="bg-white rounded-xl shadow-sm p-5 sticky top-20">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fas fa-list-ul text-green-600 mr-2"></i>
                        Ingredients
                        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium ml-2">
                            {{ recipe.ingredients|length }}
                        </span>
                    </h2>
                    <!-- Serving Adjuster -->
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">Servings:</span>
                        <button
                            class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors"
                            onclick="adjustServings(-1)">
                            <i class="fas fa-minus text-xs"></i>
                        </button>
                        <span id="serving-count" class="font-bold text-sm min-w-[1.5rem] text-center">4</span>
                        <button
                            class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors"
                            onclick="adjustServings(1)">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                </div>

                <!-- Ingredients List -->
                <div class="space-y-2" id="ingredients-list">
                    {% for ingredient in recipe.ingredients %}
                    <div
                        class="ingredient-item bg-white border border-gray-200 rounded-lg p-3 hover:border-green-300 hover:shadow-sm transition-all cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="ingredient-{{ loop.index }}"
                                class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">

                            <!-- Ingredient Image -->
                            <div class="flex-shrink-0">
                                {% if ingredient.images and ingredient.images|length > 0 %}
                                <img src="{{ ingredient.images[0].url }}" alt="{{ ingredient.name }}"
                                    class="w-10 h-10 object-cover rounded-lg cursor-pointer hover:opacity-80 transition-opacity"
                                    onclick="openImageModal('{{ ingredient.images[0].url }}')">
                                {% else %}
                                <div
                                    class="w-10 h-10 bg-gradient-to-br from-green-400 to-emerald-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-leaf text-white text-sm"></i>
                                </div>
                                {% endif %}
                            </div>

                            <label for="ingredient-{{ loop.index }}" class="flex-1 cursor-pointer">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-medium text-gray-900 text-sm">
                                            {{ ingredient.name }}
                                        </h4>
                                        <div class="text-xs text-green-600 font-medium">
                                            <span class="quantity" data-original="{{ ingredient.quantity or 0 }}">
                                                {{ ingredient.quantity or 'As needed' }}
                                            </span>
                                            {% if ingredient.unit %}
                                            <span>{{ ingredient.unit }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if ingredient.images and ingredient.images|length > 1 %}
                                    <button onclick="showIngredientImages({{ loop.index }}); event.stopPropagation();"
                                        class="text-green-600 hover:text-green-700 transition-colors p-1 rounded hover:bg-green-50">
                                        <i class="fas fa-images text-sm"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                {% if ingredient.notes %}
                                <p class="text-xs text-gray-500 mt-1">{{ ingredient.notes }}</p>
                                {% endif %}
                            </label>
                        </div>

                        <!-- Additional Ingredient Images -->
                        {% if ingredient.images and ingredient.images|length > 1 %}
                        <div class="ingredient-images mt-3 pt-3 border-t border-gray-100 hidden"
                            id="ingredient-images-{{ loop.index }}">
                            <div class="grid grid-cols-3 gap-2">
                                {% for image in ingredient.images[1:] %}
                                <div class="relative group cursor-pointer" onclick="openImageModal('{{ image.url }}')">
                                    <img src="{{ image.url }}" alt="{{ ingredient.name }}"
                                        class="w-full h-20 object-cover rounded-lg shadow-sm group-hover:shadow-md transition-all">
                                    <div
                                        class="absolute inset-0 bg-black/0 group-hover:bg-black/20 rounded-lg transition-all flex items-center justify-center">
                                        <i
                                            class="fas fa-expand text-white opacity-0 group-hover:opacity-100 transition-all"></i>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Shopping List Button -->
                <button
                    class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-medium py-3 px-4 rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all flex items-center justify-center mt-4 shadow-sm">
                    <i class="fas fa-shopping-cart mr-2"></i>
                    Add to Shopping List
                </button>
            </div>
        </div>

        <!-- Instructions Section -->
        <div class="lg:col-span-8">
            <div class="bg-white rounded-xl shadow-sm p-5 mb-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fas fa-clipboard-list text-indigo-600 mr-2"></i>
                        Instructions
                    </h2>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-500"><span id="progress-count">0</span>/{{
                            recipe.steps|length }}</span>
                        <button class="text-gray-500 hover:text-indigo-600 transition-colors" title="Cook Mode">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-5">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar"
                            class="bg-gradient-to-r from-indigo-500 to-purple-600 h-2 rounded-full transition-all duration-500"
                            style="width: 0%"></div>
                    </div>
                </div>

                <!-- Steps -->
                <div class="space-y-4" id="steps-container">
                    {% for step in recipe.steps %}
                    <div class="step-card bg-white border border-gray-200 rounded-xl p-4 transition-all"
                        data-step="{{ loop.index }}">
                        <div class="flex items-start space-x-4">
                            <!-- Step Number/Image -->
                            <div class="flex-shrink-0">
                                {% if step.images and step.images|length > 0 %}
                                <div class="relative cursor-pointer"
                                    onclick="openImageModal('{{ step.images[0].url }}')">
                                    <img src="{{ step.images[0].url }}" alt="Step {{ step.step_number }}"
                                        class="w-14 h-14 object-cover rounded-lg hover:opacity-90 transition-opacity">
                                    <div
                                        class="absolute -bottom-1 -right-1 step-number-circle bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow-md">
                                        {{ step.step_number }}
                                    </div>
                                </div>
                                {% else %}
                                <div
                                    class="step-number-circle bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-lg w-14 h-14 flex items-center justify-center text-xl font-bold shadow-sm transition-all">
                                    {{ step.step_number }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                        <h4 class="text-base font-bold text-gray-900">
                                            {{ step.name or 'Step ' + step.step_number|string }}
                                        </h4>
                                        <div class="flex items-center space-x-3 mt-1">
                                            {% if step.duration %}
                                            <div class="flex items-center text-orange-600 text-xs">
                                                <i class="fas fa-clock mr-1"></i>
                                                <span>{{ step.duration }} min</span>
                                            </div>
                                            {% endif %}
                                            {% if step.images and step.images|length > 0 %}
                                            <button onclick="showStepImages({{ loop.index }})"
                                                class="flex items-center text-indigo-600 text-xs hover:text-indigo-800 transition-colors hover:bg-indigo-50 px-2 py-1 rounded">
                                                <i class="fas fa-images mr-1"></i>
                                                <span>{{ step.images|length }} photo{{ 's' if step.images|length > 1
                                                    }}</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <button
                                        class="step-complete-btn text-gray-400 hover:text-green-600 transition-all p-1"
                                        onclick="toggleStepComplete({{ loop.index }})">
                                        <i class="fas fa-check-circle text-xl"></i>
                                    </button>
                                </div>

                                <div class="bg-gray-50 rounded-lg p-3 mb-2">
                                    <p class="text-gray-800 leading-relaxed text-sm">{{ step.instruction }}</p>
                                </div>

                                {% if step.description %}
                                <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r-lg">
                                    <div class="flex items-start">
                                        <i class="fas fa-lightbulb text-blue-600 mr-2 mt-0.5"></i>
                                        <div>
                                            <h5 class="font-medium text-blue-900 text-xs mb-1">Pro Tip</h5>
                                            <p class="text-blue-800 text-sm">{{ step.description }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Step Images Gallery -->
                                {% if step.images %}
                                <div class="step-images mt-4 pt-4 border-t border-gray-200 hidden"
                                    id="step-images-{{ loop.index }}">
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {% for image in step.images %}
                                        <div class="relative group cursor-pointer"
                                            onclick="openImageModal('{{ image.url }}')">
                                            <img src="{{ image.url }}" alt="Step {{ step.step_number }}"
                                                class="w-full h-28 object-cover rounded-lg shadow-sm group-hover:shadow-md transition-all">
                                            <div
                                                class="absolute inset-0 bg-black/0 group-hover:bg-black/30 rounded-lg transition-all flex items-center justify-center">
                                                <div
                                                    class="bg-white/90 p-2 rounded-full opacity-0 group-hover:opacity-100 transition-all">
                                                    <i class="fas fa-expand text-indigo-600"></i>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Completion Celebration -->
                <div id="completion-celebration" class="hidden text-center py-6 mt-4 border-t border-gray-200">
                    <div class="text-5xl mb-3">ðŸŽ‰</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Congratulations!</h3>
                    <p class="text-gray-600 mb-4">You've completed the recipe. How did it turn out?</p>
                    <div class="flex items-center justify-center space-x-3">
                        <button
                            class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-2 rounded-lg font-medium hover:from-indigo-700 hover:to-purple-700 transition-all shadow-sm">
                            Rate Recipe
                        </button>
                        <button
                            class="bg-gray-100 text-gray-700 px-6 py-2 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                            Add to Meal Plan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="bg-white rounded-xl shadow-sm p-5">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-comments text-blue-600 mr-2"></i>
                    Comments & Reviews
                    {% if recipe.comments %}
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium ml-2">
                        {{ recipe.comments|length }}
                    </span>
                    {% endif %}
                </h3>

                {% if recipe.comments %}
                <div class="space-y-3 mb-5">
                    {% for comment in recipe.comments[:3] %}
                    <div class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors">
                        <div class="flex items-start space-x-3">
                            <div
                                class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full w-9 h-9 flex items-center justify-center text-white font-semibold flex-shrink-0">
                                {{ (comment.author.name or 'U')[0].upper() }}
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <h4 class="font-medium text-gray-800 text-sm">{{ comment.author.name or
                                        'Anonymous' }}</h4>
                                    <span class="text-xs text-gray-500">{{ comment.created_at.strftime('%b %d, %Y')
                                        }}</span>
                                </div>
                                <p class="text-gray-700 leading-relaxed text-sm">{{ comment.content }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 mb-5">
                    <i class="fas fa-comments text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">Be the first to share your thoughts!</p>
                </div>
                {% endif %}

                <!-- Add Comment Form -->
                <div class="border-t border-gray-200 pt-5">
                    <h4 class="font-semibold text-gray-800 mb-3">Leave a Comment</h4>
                    <form method="POST" action="{{ url_for('dashboard.add_comment', recipe_id=recipe.id) }}"
                        class="space-y-3">
                        {{ form.hidden_tag() }}
                        {{ form.comment_text(class="w-full border border-gray-300 rounded-lg shadow-sm py-3 px-4
                        focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none",
                        rows=3, placeholder="Share your experience with this recipe...") }}
                        <div class="flex justify-end">
                            {{ form.submit(class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white
                            font-medium py-2 px-6 rounded-lg hover:from-indigo-700 hover:to-purple-700
                            transition-all shadow-sm") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<div class="floating-action-btn">
    <a href="{{ url_for('planner.index', add_recipe_id=recipe.id) }}"
        class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-105 flex items-center justify-center"
        title="Add to Meal Plan">
        <i class="fas fa-calendar-plus text-lg"></i>
    </a>
</div>

<!-- Image Modal -->
<div id="image-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden"
    onclick="closeImageModal()">
    <div class="relative max-w-6xl max-h-[90vh] p-4" onclick="event.stopPropagation()">
        <button onclick="closeImageModal()"
            class="absolute -top-3 -right-3 bg-white text-gray-800 w-10 h-10 rounded-full hover:bg-gray-100 transition-colors z-10 flex items-center justify-center shadow-lg">
            <i class="fas fa-times text-lg"></i>
        </button>
        <img id="modal-image" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
    </div>
</div>

<!-- Image Gallery Modal -->
<div id="gallery-modal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-50 hidden"
    onclick="closeImageGallery()">
    <div class="relative w-full h-full p-4" onclick="event.stopPropagation()">
        <button onclick="closeImageGallery()"
            class="absolute top-6 right-6 bg-white text-gray-800 w-10 h-10 rounded-full hover:bg-gray-100 transition-colors z-10 flex items-center justify-center shadow-lg">
            <i class="fas fa-times text-lg"></i>
        </button>
        <div class="h-full flex items-center justify-center overflow-y-auto">
            <div class="max-w-6xl w-full py-12">
                <h3 class="text-white text-2xl font-bold mb-6 text-center">All Recipe Images</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {% for image in recipe.images %}
                    <div class="relative group cursor-pointer transform hover:scale-105 transition-all"
                        onclick="openImageModal('{{ image.url }}'); closeImageGallery();">
                        <img src="{{ image.url }}" alt="{{ recipe.name }}"
                            class="w-full h-48 object-cover rounded-lg shadow-lg">
                        <div
                            class="absolute inset-0 bg-black/0 group-hover:bg-black/30 rounded-lg transition-all flex items-center justify-center">
                            <i
                                class="fas fa-expand text-white text-xl opacity-0 group-hover:opacity-100 transition-all"></i>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script>
    let completedSteps = 0;
    const totalSteps = {{ recipe.steps| length }};
    let currentServings = 4;

    function adjustServings(change) {
        const newServings = Math.max(1, currentServings + change);
        if (newServings !== currentServings) {
            currentServings = newServings;
            document.getElementById('serving-count').textContent = currentServings;
            document.querySelectorAll('.quantity').forEach(el => {
                const original = parseFloat(el.dataset.original) || 0;
                if (original > 0) {
                    const newAmount = (original * currentServings / 4).toFixed(2);
                    el.textContent = parseFloat(newAmount) === parseInt(newAmount) ? parseInt(newAmount) : newAmount;
                }
            });
        }
    }

    function toggleStepComplete(stepNumber) {
        const stepCard = document.querySelector(`[data-step="${stepNumber}"]`);
        const stepCircle = stepCard.querySelector('.step-number-circle');
        const completeBtn = stepCard.querySelector('.step-complete-btn');

        if (stepCard.classList.contains('completed')) {
            stepCard.classList.remove('completed');
            stepCircle.classList.remove('completed');
            completeBtn.classList.remove('text-green-600');
            completeBtn.classList.add('text-gray-400');
            completedSteps--;
        } else {
            stepCard.classList.add('completed');
            stepCircle.classList.add('completed');
            completeBtn.classList.remove('text-gray-400');
            completeBtn.classList.add('text-green-600');
            completedSteps++;
        }
        updateProgress();
    }

    function updateProgress() {
        const progressBar = document.getElementById('progress-bar');
        const progressCount = document.getElementById('progress-count');
        const completionCelebration = document.getElementById('completion-celebration');

        const percentage = (completedSteps / totalSteps) * 100;
        progressBar.style.width = percentage + '%';
        progressCount.textContent = completedSteps;

        if (completedSteps === totalSteps && totalSteps > 0) {
            setTimeout(() => {
                completionCelebration.classList.remove('hidden');
                completionCelebration.scrollIntoView({ behavior: 'smooth' });
            }, 500);
        } else {
            completionCelebration.classList.add('hidden');
        }
    }

    // Show/hide step images
    function showStepImages(stepNumber) {
        const imagesDiv = document.getElementById(`step-images-${stepNumber}`);
        imagesDiv.classList.toggle('hidden');
    }

    // Show/hide ingredient images
    function showIngredientImages(ingredientNumber) {
        const imagesDiv = document.getElementById(`ingredient-images-${ingredientNumber}`);
        imagesDiv.classList.toggle('hidden');
    }

    // Image modal
    function openImageModal(imageSrc) {
        const modal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        modalImage.src = imageSrc;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        const modal = document.getElementById('image-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Show image gallery
    function showImageGallery() {
        const galleryModal = document.getElementById('gallery-modal');
        if (galleryModal) {
            galleryModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeImageGallery() {
        const galleryModal = document.getElementById('gallery-modal');
        if (galleryModal) {
            galleryModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    }

    // Close modal on escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeImageModal();
            closeImageGallery();
        }
    });

    // Ingredient checkbox handling
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            this.closest('.ingredient-item').classList.toggle('checked', this.checked);
        });
    });

    // Auto-save progress to localStorage
    function saveProgress() {
        const progress = {
            completedSteps: Array.from(document.querySelectorAll('.step-card.completed')).map(card =>
                parseInt(card.dataset.step)
            ),
            checkedIngredients: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.id),
            currentServings: currentServings
        };
        localStorage.setItem('recipe-{{ recipe.id }}-progress', JSON.stringify(progress));
    }

    // Load progress from localStorage
    function loadProgress() {
        const saved = localStorage.getItem('recipe-{{ recipe.id }}-progress');
        if (saved) {
            const progress = JSON.parse(saved);

            // Restore completed steps
            if (progress.completedSteps) {
                progress.completedSteps.forEach(stepNumber => {
                    toggleStepComplete(stepNumber);
                });
            }

            // Restore checked ingredients
            if (progress.checkedIngredients) {
                progress.checkedIngredients.forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.closest('.ingredient-item').classList.add('checked');
                    }
                });
            }

            // Restore servings
            if (progress.currentServings && progress.currentServings !== currentServings) {
                const diff = progress.currentServings - currentServings;
                adjustServings(diff);
            }
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        loadProgress();

        // Save progress on changes
        document.addEventListener('change', saveProgress);
        document.querySelectorAll('.step-complete-btn').forEach(btn => {
            btn.addEventListener('click', saveProgress);
        });

        // Initialize mobile menu toggle
        initializeMobileMenu();
    });

    // Mobile menu functionality
    function initializeMobileMenu() {
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');

        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', function () {
                mobileMenu.classList.toggle('hidden');
            });

            // Close menu when clicking outside
            document.addEventListener('click', function (e) {
                if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });
        }
    }

    // Enhanced favorite functionality
    function toggleFavorite() {
        const heartIcons = document.querySelectorAll('.fa-heart');
        heartIcons.forEach(icon => {
            if (icon.classList.contains('far')) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                icon.style.color = '#ef4444';
                showToast('Recipe added to favorites!');
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                icon.style.color = '';
                showToast('Recipe removed from favorites!');
            }
        });
    }

    // Share functionality
    function shareRecipe() {
        if (navigator.share) {
            navigator.share({
                title: '{{ recipe.name }}',
                text: 'Check out this amazing recipe: {{ recipe.name }}',
                url: window.location.href
            }).then(() => {
                showToast('Recipe shared successfully!');
            }).catch((error) => {
                console.log('Error sharing:', error);
                fallbackShare();
            });
        } else {
            fallbackShare();
        }
    }

    // Fallback share functionality
    function fallbackShare() {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(window.location.href).then(() => {
                showToast('Recipe link copied to clipboard!');
            }).catch(() => {
                showToast('Unable to copy link');
            });
        } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = window.location.href;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Recipe link copied to clipboard!');
            } catch (err) {
                showToast('Unable to copy link');
            }
            document.body.removeChild(textArea);
        }
    }

    // Print functionality
    function printRecipe() {
        // Hide non-essential elements for printing
        const elementsToHide = document.querySelectorAll('.sticky, .floating-action-btn, .mobile-action-button, .action-button, #mobileMenu');
        elementsToHide.forEach(el => el.style.display = 'none');

        // Print the page
        window.print();

        // Restore hidden elements
        elementsToHide.forEach(el => el.style.display = '');

        showToast('Print dialog opened!');
    }

    // Enhanced toast notification
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 z-50 max-w-sm w-full bg-white border border-gray-200 rounded-lg shadow-lg transform translate-y-full transition-transform duration-300`;

        const bgColor = type === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
        const iconColor = type === 'success' ? 'text-green-600' : 'text-red-600';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

        toast.innerHTML = `
            <div class="p-4 flex items-center gap-3 ${bgColor}">
                <i class="fas ${icon} ${iconColor}"></i>
                <p class="text-gray-900 font-medium">${message}</p>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.remove('translate-y-full');
        }, 100);

        // Auto remove after 4 seconds
        setTimeout(() => {
            toast.classList.add('translate-y-full');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 300);
        }, 4000);
    }
</script>
{% endblock %}
