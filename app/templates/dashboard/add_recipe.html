{% extends "dashboard/base.html" %}

{% block title %}Add Recipe{% endblock %}

{% block dashboard_content %}
<style>
    .modal-content {
        animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(-20px);
        }

        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .ingredient-card,
    .step-card {
        transition: all 0.2s ease;
    }

    .ingredient-card:hover,
    .step-card:hover {
        transform: translateY(-1px);
    }

    #upload-zone {
        transition: all 0.3s ease;
    }

    #upload-zone.dragover {
        transform: scale(1.02);
        box-shadow: 0 10px 25px rgba(79, 70, 229, 0.1);
    }

    .image-preview-item {
        animation: fadeInUp 0.3s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Modal image upload zones */
    #ingredient-upload-zone.dragover,
    #step-upload-zone.dragover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Smooth transitions for all elements */
    .transition-all {
        transition: all 0.2s ease-in-out;
    }

    /* Custom scrollbar for ingredients/steps lists */
    #ingredients-list::-webkit-scrollbar,
    #steps-list::-webkit-scrollbar {
        width: 4px;
    }

    #ingredients-list::-webkit-scrollbar-track,
    #steps-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 2px;
    }

    #ingredients-list::-webkit-scrollbar-thumb,
    #steps-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 2px;
    }

    #ingredients-list::-webkit-scrollbar-thumb:hover,
    #steps-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
</style>

<div class="min-h-screen bg-gray-50">
    <!-- Compact Header -->
    <div class="bg-white border-b px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Create New Recipe</h1>
                <p class="text-gray-600 text-sm">Share your culinary creation with the world</p>
            </div>
            <div class="flex space-x-3">
                <a href="{{ url_for('dashboard.my_recipes') }}"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md">
                    Cancel
                </a>
                <button type="submit" form="recipe-form"
                    class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    Create Recipe
                </button>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages" style="display: none;">
        {% for category, message in messages %}
        <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-6">
        <form id="recipe-form" method="POST" action="{{ url_for('dashboard.add_recipe') }}"
            enctype="multipart/form-data">
            {{ form.hidden_tag() }}

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Basic Info -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-sm border p-6 sticky top-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h2>

                        <div class="space-y-4">
                            <div>
                                {{ form.name.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                                {{ form.name(class="w-full px-3 py-2 border border-gray-300 rounded-md
                                focus:ring-indigo-500 focus:border-indigo-500") }}
                            </div>

                            <div>
                                {{ form.description.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                                {{ form.description(class="w-full px-3 py-2 border border-gray-300 rounded-md
                                focus:ring-indigo-500 focus:border-indigo-500", rows=3) }}
                            </div>

                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    {{ form.category_id.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                                    {{ form.category_id(class="w-full px-3 py-2 border border-gray-300 rounded-md
                                    focus:ring-indigo-500 focus:border-indigo-500") }}
                                </div>

                                <div>
                                    {{ form.origin_id.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                                    {{ form.origin_id(class="w-full px-3 py-2 border border-gray-300 rounded-md
                                    focus:ring-indigo-500 focus:border-indigo-500") }}
                                </div>
                            </div>

                            <div class="flex items-center">
                                {{ form.public(class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300
                                rounded") }}
                                {{ form.public.label(class="ml-2 block text-sm text-gray-900") }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Middle Column: Images -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Recipe Images</h2>

                        <div class="space-y-4">
                            <!-- Upload Area -->
                            <div id="upload-zone"
                                class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-400 hover:bg-indigo-50 transition-all duration-200 cursor-pointer group">
                                {{ form.recipe_images(class="hidden", multiple=True, accept="image/*",
                                id="recipe-images") }}
                                <div id="upload-area" class="space-y-3">
                                    <div
                                        class="w-16 h-16 mx-auto bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-indigo-100 transition-colors">
                                        <i class="fas fa-camera text-2xl text-gray-400 group-hover:text-indigo-500"></i>
                                    </div>
                                    <div>
                                        <p class="text-lg font-medium text-gray-700 group-hover:text-indigo-600">Upload
                                            Recipe Images</p>
                                        <p class="text-sm text-gray-500">Drag & drop or click to browse</p>
                                        <p class="text-xs text-gray-400 mt-1">PNG, JPG, GIF, WEBP up to 30MB each</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Image Preview Grid -->
                            <div id="image-preview" class="grid grid-cols-2 sm:grid-cols-3 gap-3 hidden"></div>

                            <!-- Upload Progress -->
                            <div id="upload-progress" class="hidden">
                                <div class="bg-gray-200 rounded-full h-2">
                                    <div id="progress-bar"
                                        class="bg-indigo-600 h-2 rounded-full transition-all duration-300"
                                        style="width: 0%"></div>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">Uploading images...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Ingredients & Steps -->
                <div class="lg:col-span-1">
                    <div class="space-y-6">
                        <!-- Ingredients Section -->
                        <div class="bg-white rounded-lg shadow-sm border p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">Ingredients</h2>
                                <button type="button" id="add-ingredient-btn"
                                    class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600 transition-colors flex items-center space-x-1 shadow-sm">
                                    <i class="fas fa-plus text-xs"></i>
                                    <span>Add</span>
                                </button>
                            </div>

                            <div id="ingredients-list" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="text-gray-500 text-sm" id="no-ingredients">No ingredients added yet</p>
                            </div>
                        </div>

                        <!-- Steps Section -->
                        <div class="bg-white rounded-lg shadow-sm border p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold text-gray-900">Cooking Steps</h2>
                                <button type="button" id="add-step-btn"
                                    class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-orange-600 transition-colors flex items-center space-x-1 shadow-sm">
                                    <i class="fas fa-plus text-xs"></i>
                                    <span>Add</span>
                                </button>
                            </div>

                            <div id="steps-list" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="text-gray-500 text-sm" id="no-steps">No steps added yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Ingredient Modal -->
<div id="ingredient-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden backdrop-blur-sm">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div
            class="bg-white rounded-xl max-w-lg w-full p-6 shadow-2xl transform transition-all duration-300 scale-95 modal-content">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-carrot text-green-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Add Ingredient</h3>
                </div>
                <button type="button"
                    class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors"
                    onclick="closeIngredientModal()">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <form id="ingredient-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ingredient Name *</label>
                    <input type="text" id="ingredient-name" placeholder="e.g., Chicken breast"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                        required>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                        <input type="text" id="ingredient-quantity" placeholder="2"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                        <input type="text" id="ingredient-unit" placeholder="cups"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
                    <input type="text" id="ingredient-notes" placeholder="diced, organic, etc."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Images (optional)</label>

                    <!-- Ingredient Image Upload Zone -->
                    <div id="ingredient-upload-zone"
                        class="border-2 border-dashed border-green-300 rounded-lg p-4 text-center hover:border-green-400 hover:bg-green-50 transition-all duration-200 cursor-pointer group">
                        <input type="file" id="ingredient-images" multiple accept="image/*" class="hidden">
                        <div id="ingredient-upload-area" class="space-y-2">
                            <div
                                class="w-12 h-12 mx-auto bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors">
                                <i class="fas fa-image text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-700 group-hover:text-green-600">Upload Images
                                </p>
                                <p class="text-xs text-gray-500">Drag & drop or click</p>
                            </div>
                        </div>
                    </div>

                    <!-- Ingredient Image Preview -->
                    <div id="ingredient-image-preview" class="grid grid-cols-3 gap-2 mt-3 hidden"></div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeIngredientModal()"
                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                        Add Ingredient
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Step Modal -->
<div id="step-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden backdrop-blur-sm">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div
            class="bg-white rounded-xl max-w-lg w-full p-6 shadow-2xl transform transition-all duration-300 scale-95 modal-content">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-list-ol text-orange-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900">Add Cooking Step</h3>
                </div>
                <button type="button"
                    class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors"
                    onclick="closeStepModal()">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <form id="step-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Step Name (optional)</label>
                    <input type="text" id="step-name" placeholder="e.g., Prepare vegetables"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Instructions *</label>
                    <textarea id="step-instruction" placeholder="Describe what to do in this step..." rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 resize-none"
                        required></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Duration (minutes)</label>
                    <input type="number" id="step-duration" placeholder="15" min="1"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Additional Notes (optional)</label>
                    <textarea id="step-description" placeholder="Tips, warnings, or additional information..." rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 resize-none"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Images (optional)</label>

                    <!-- Step Image Upload Zone -->
                    <div id="step-upload-zone"
                        class="border-2 border-dashed border-orange-300 rounded-lg p-4 text-center hover:border-orange-400 hover:bg-orange-50 transition-all duration-200 cursor-pointer group">
                        <input type="file" id="step-images" multiple accept="image/*" class="hidden">
                        <div id="step-upload-area" class="space-y-2">
                            <div
                                class="w-12 h-12 mx-auto bg-orange-100 rounded-full flex items-center justify-center group-hover:bg-orange-200 transition-colors">
                                <i class="fas fa-image text-orange-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-700 group-hover:text-orange-600">Upload Images
                                </p>
                                <p class="text-xs text-gray-500">Drag & drop or click</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step Image Preview -->
                    <div id="step-image-preview" class="grid grid-cols-3 gap-2 mt-3 hidden"></div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeStepModal()"
                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">
                        Add Step
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Hidden form fields container -->
<div id="hidden-fields" style="display: none;"></div>

<script>
    let ingredientCount = 0;
    let stepCount = 0;
    let ingredients = [];
    let steps = [];

    // Modal Functions with animations
    function openIngredientModal() {
        const modal = document.getElementById('ingredient-modal');
        const content = modal.querySelector('.modal-content');

        modal.classList.remove('hidden');
        content.classList.remove('scale-95');
        content.classList.add('scale-100');

        setTimeout(() => {
            document.getElementById('ingredient-name').focus();
        }, 100);
    }

    function closeIngredientModal() {
        const modal = document.getElementById('ingredient-modal');
        const content = modal.querySelector('.modal-content');

        content.classList.remove('scale-100');
        content.classList.add('scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('ingredient-form').reset();
            clearIngredientPreviews();
        }, 150);
    }

    function openStepModal() {
        const modal = document.getElementById('step-modal');
        const content = modal.querySelector('.modal-content');

        modal.classList.remove('hidden');
        content.classList.remove('scale-95');
        content.classList.add('scale-100');

        setTimeout(() => {
            document.getElementById('step-instruction').focus();
        }, 100);
    }

    function closeStepModal() {
        const modal = document.getElementById('step-modal');
        const content = modal.querySelector('.modal-content');

        content.classList.remove('scale-100');
        content.classList.add('scale-95');

        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('step-form').reset();
            clearStepPreviews();
        }, 150);
    }

    // Add ingredient from modal
    document.getElementById('ingredient-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const name = document.getElementById('ingredient-name').value.trim();
        const quantity = document.getElementById('ingredient-quantity').value.trim();
        const unit = document.getElementById('ingredient-unit').value.trim();
        const notes = document.getElementById('ingredient-notes').value.trim();
        const images = document.getElementById('ingredient-images').files;

        if (!name) {
            alert('Ingredient name is required');
            return;
        }

        const ingredient = {
            id: ingredientCount,
            name: name,
            quantity: quantity,
            unit: unit,
            notes: notes,
            images: images
        };

        ingredients.push(ingredient);
        console.log('Added ingredient:', ingredient);
        console.log('Total ingredients:', ingredients.length);
        renderIngredients();
        createHiddenIngredientFields();
        closeIngredientModal();
        ingredientCount++;
    });

    // Add step from modal
    document.getElementById('step-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const name = document.getElementById('step-name').value.trim();
        const instruction = document.getElementById('step-instruction').value.trim();
        const duration = document.getElementById('step-duration').value.trim();
        const description = document.getElementById('step-description').value.trim();
        const images = document.getElementById('step-images').files;

        if (!instruction) {
            alert('Step instruction is required');
            return;
        }

        const step = {
            id: stepCount,
            number: steps.length + 1,
            name: name,
            instruction: instruction,
            duration: duration,
            description: description,
            images: images
        };

        steps.push(step);
        console.log('Added step:', step);
        console.log('Total steps:', steps.length);
        renderSteps();
        createHiddenStepFields();
        closeStepModal();
        stepCount++;
    });

    // Render ingredients list
    function renderIngredients() {
        const container = document.getElementById('ingredients-list');
        const noIngredientsMsg = document.getElementById('no-ingredients');

        if (ingredients.length === 0) {
            noIngredientsMsg.style.display = 'block';
            return;
        }

        noIngredientsMsg.style.display = 'none';

        container.innerHTML = ingredients.map(ingredient => {
            // Check if ingredient has images
            const hasImages = ingredient.images && ingredient.images.length > 0;
            const firstImage = hasImages ? ingredient.images[0] : null;

            // Create image preview URL if available
            let imagePreview = '';
            if (hasImages && firstImage) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imgElement = document.querySelector(`[data-ingredient-id="${ingredient.id}"] .ingredient-image`);
                    if (imgElement) {
                        imgElement.src = e.target.result;
                        imgElement.style.display = 'block';
                        imgElement.parentElement.querySelector('.ingredient-icon').style.display = 'none';
                    }
                };
                reader.readAsDataURL(firstImage);
            }

            return `
            <div class="bg-gradient-to-r from-green-50 to-green-100 border border-green-200 rounded-lg p-3 flex justify-between items-center hover:shadow-sm transition-shadow group" data-ingredient-id="${ingredient.id}">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden bg-green-500">
                        <img class="ingredient-image w-full h-full object-cover rounded-full" style="display: none;" alt="${ingredient.name}">
                        <i class="ingredient-icon fas fa-leaf text-white text-xs"></i>
                    </div>
                    <div>
                        <div class="font-medium text-gray-900">${ingredient.name}</div>
                        <div class="text-sm text-gray-600">
                            ${ingredient.quantity || ingredient.unit ?
                    `${ingredient.quantity || ''} ${ingredient.unit || ''}`.trim() :
                    'As needed'
                }
                            ${ingredient.notes ? `• ${ingredient.notes}` : ''}
                        </div>
                        ${hasImages ? `<div class="text-xs text-green-600 mt-1"><i class="fas fa-camera mr-1"></i>${ingredient.images.length} image${ingredient.images.length > 1 ? 's' : ''}</div>` : ''}
                    </div>
                </div>
                <button type="button" onclick="removeIngredient(${ingredient.id})"
                    class="text-red-400 hover:text-red-600 ml-2 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-red-50">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            </div>
        `;
        }).join('') + `<div class="text-gray-500 text-sm" id="no-ingredients" style="display: none;">No ingredients added yet</div>`;
    }

    // Render steps list
    function renderSteps() {
        const container = document.getElementById('steps-list');
        const noStepsMsg = document.getElementById('no-steps');

        if (steps.length === 0) {
            noStepsMsg.style.display = 'block';
            return;
        }

        noStepsMsg.style.display = 'none';

        container.innerHTML = steps.map((step, index) => {
            // Check if step has images
            const hasImages = step.images && step.images.length > 0;
            const firstImage = hasImages ? step.images[0] : null;

            // Create image preview URL if available
            if (hasImages && firstImage) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imgElement = document.querySelector(`[data-step-id="${step.id}"] .step-image`);
                    if (imgElement) {
                        imgElement.src = e.target.result;
                        imgElement.style.display = 'block';
                        imgElement.parentElement.querySelector('.step-number').style.display = 'none';
                    }
                };
                reader.readAsDataURL(firstImage);
            }

            return `
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 border border-orange-200 rounded-lg p-3 flex justify-between items-start hover:shadow-sm transition-shadow group" data-step-id="${step.id}">
                <div class="flex space-x-3 flex-1">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5 overflow-hidden bg-orange-500">
                        <img class="step-image w-full h-full object-cover rounded-full" style="display: none;" alt="Step ${index + 1}">
                        <span class="step-number text-white text-xs font-bold">${index + 1}</span>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-900 mb-1">
                            ${step.name ? step.name : `Step ${index + 1}`}
                        </div>
                        <div class="text-sm text-gray-600 leading-relaxed">${step.instruction}</div>
                        ${step.duration ? `<div class="flex items-center mt-2 text-xs text-orange-600">
                            <i class="fas fa-clock mr-1"></i>
                            ${step.duration} minutes
                        </div>` : ''}
                        ${step.description ? `<div class="text-xs text-gray-500 mt-1 italic">${step.description}</div>` : ''}
                        ${hasImages ? `<div class="text-xs text-orange-600 mt-1"><i class="fas fa-camera mr-1"></i>${step.images.length} image${step.images.length > 1 ? 's' : ''}</div>` : ''}
                    </div>
                </div>
                <button type="button" onclick="removeStep(${step.id})"
                    class="text-red-400 hover:text-red-600 ml-2 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-red-50 flex-shrink-0">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            </div>
        `;
        }).join('') + `<div class="text-gray-500 text-sm" id="no-steps" style="display: none;">No steps added yet</div>`;
    }

    // Remove ingredient
    function removeIngredient(id) {
        ingredients = ingredients.filter(ingredient => ingredient.id !== id);
        renderIngredients();
        createHiddenIngredientFields();
    }

    // Remove step
    function removeStep(id) {
        steps = steps.filter(step => step.id !== id);
        // Renumber steps
        steps.forEach((step, index) => {
            step.number = index + 1;
        });
        renderSteps();
        createHiddenStepFields();
    }

    // Create hidden form fields for ingredients
    function createHiddenIngredientFields() {
        const form = document.getElementById('recipe-form');
        console.log('Creating hidden ingredient fields for', ingredients.length, 'ingredients');

        // Remove existing ingredient fields from the form
        form.querySelectorAll('[name*="ingredients-"]').forEach(field => field.remove());

        ingredients.forEach((ingredient, index) => {
            // Create hidden input fields with correct WTForms FieldList structure
            const fields = [
                { name: `ingredients-${index}-name`, value: ingredient.name },
                { name: `ingredients-${index}-quantity`, value: ingredient.quantity || '' },
                { name: `ingredients-${index}-unit`, value: ingredient.unit || '' },
                { name: `ingredients-${index}-notes`, value: ingredient.notes || '' }
            ];

            fields.forEach(field => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = field.name;
                input.value = field.value;
                form.appendChild(input);
                console.log('Created hidden field:', field.name, '=', field.value);
            });
        });
    }

    // Create hidden form fields for steps
    function createHiddenStepFields() {
        const form = document.getElementById('recipe-form');

        // Remove existing step fields from the form
        form.querySelectorAll('[name*="steps-"]').forEach(field => field.remove());

        steps.forEach((step, index) => {
            // Create hidden input fields with correct WTForms FieldList structure
            const fields = [
                { name: `steps-${index}-step_number`, value: step.number },
                { name: `steps-${index}-instruction`, value: step.instruction },
                { name: `steps-${index}-name`, value: step.name || '' },
                { name: `steps-${index}-duration`, value: step.duration || '' },
                { name: `steps-${index}-description`, value: step.description || '' }
            ];

            fields.forEach(field => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = field.name;
                input.value = field.value;
                form.appendChild(input);
                console.log('Created hidden step field:', field.name, '=', field.value);
            });
        });
    }

    // Image upload handling with drag & drop
    const uploadZone = document.getElementById('upload-zone');
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('recipe-images');
    const preview = document.getElementById('image-preview');
    const progressContainer = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');

    // Click to upload
    uploadArea.addEventListener('click', function () {
        fileInput.click();
    });

    // Drag & drop functionality
    uploadZone.addEventListener('dragover', function (e) {
        e.preventDefault();
        uploadZone.classList.add('border-indigo-500', 'bg-indigo-50');
    });

    uploadZone.addEventListener('dragleave', function (e) {
        e.preventDefault();
        uploadZone.classList.remove('border-indigo-500', 'bg-indigo-50');
    });

    uploadZone.addEventListener('drop', function (e) {
        e.preventDefault();
        uploadZone.classList.remove('border-indigo-500', 'bg-indigo-50');

        const files = e.dataTransfer.files;
        handleFiles(files);
    });

    // File input change
    fileInput.addEventListener('change', function (e) {
        handleFiles(e.target.files);
    });

    // Handle file processing
    function handleFiles(files) {
        if (files.length === 0) return;

        // Show progress
        progressContainer.classList.remove('hidden');
        preview.classList.remove('hidden');
        preview.innerHTML = '';

        let loadedFiles = 0;
        const totalFiles = files.length;

        Array.from(files).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                // Validate file size (30MB max)
                if (file.size > 30 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Maximum size is 30MB.`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    console.log('FileReader loaded file:', file.name, 'data URL length:', e.target.result ? e.target.result.length : 'undefined');
                    createImagePreview(e.target.result, file.name, index);
                    loadedFiles++;

                    // Update progress
                    const progress = (loadedFiles / totalFiles) * 100;
                    progressBar.style.width = progress + '%';

                    // Hide progress when complete
                    if (loadedFiles === totalFiles) {
                        setTimeout(() => {
                            progressContainer.classList.add('hidden');
                        }, 500);
                    }
                };
                reader.onerror = function (e) {
                    console.error('FileReader error for file:', file.name, e);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Create image preview
    function createImagePreview(src, filename, index) {
        console.log('Creating image preview for:', filename, 'with src length:', src ? src.length : 'undefined');

        const previewItem = document.createElement('div');
        previewItem.className = 'relative group image-preview-item';
        previewItem.innerHTML = `
            <div class="relative overflow-hidden rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-all duration-200 bg-white">
                <img src="${src}" class="w-full h-24 object-cover bg-gray-100" alt="${filename}" onload="console.log('Image loaded:', '${filename}')" onerror="console.error('Image failed to load:', '${filename}')">
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200"></div>
                <button type="button" onclick="removeImage(${index})"
                    class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 flex items-center justify-center">
                    ×
                </button>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-2">
                    <p class="text-white text-xs truncate font-medium">${filename}</p>
                </div>
            </div>
        `;
        preview.appendChild(previewItem);
    }

    // Remove image
    function removeImage(index) {
        const previewItems = preview.children;
        if (previewItems[index]) {
            previewItems[index].remove();
        }

        // If no images left, hide preview
        if (preview.children.length === 0) {
            preview.classList.add('hidden');
        }
    }

    // Form validation and submission
    document.getElementById('recipe-form').addEventListener('submit', function (e) {
        console.log('Form submission started');
        console.log('Current ingredients:', ingredients.length);
        console.log('Current steps:', steps.length);

        // Clear previous error messages
        clearErrorMessages();

        const nameField = document.querySelector('[name="name"]');
        let errors = [];

        // Check recipe name
        if (!nameField.value.trim()) {
            errors.push('Recipe name is required.');
        }

        // Check ingredients
        if (ingredients.length === 0) {
            errors.push('At least one ingredient is required.');
        }

        // Check steps
        if (steps.length === 0) {
            errors.push('At least one cooking step is required.');
        }

        if (errors.length > 0) {
            console.log('Validation errors:', errors);
            e.preventDefault();
            showErrorMessage('Validation Failed', errors);
            return false;
        }

        // Ensure hidden fields are created before submission
        console.log('Creating hidden fields for submission...');
        createHiddenIngredientFields();
        createHiddenStepFields();

        // Show debug info
        showDebugInfo();

        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Creating Recipe...';
        submitBtn.disabled = true;

        console.log('Form is being submitted');

        // Re-enable button if form submission fails
        setTimeout(() => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            showErrorMessage('Form Submission Timeout', ['The form submission took too long. Please try again.']);
        }, 10000);
    });

    // Ingredient modal image upload functionality
    function setupIngredientImageUpload() {
        const uploadZone = document.getElementById('ingredient-upload-zone');
        const uploadArea = document.getElementById('ingredient-upload-area');
        const fileInput = document.getElementById('ingredient-images');
        const preview = document.getElementById('ingredient-image-preview');

        // Click to upload
        uploadArea.addEventListener('click', function () {
            fileInput.click();
        });

        // Drag & drop functionality
        uploadZone.addEventListener('dragover', function (e) {
            e.preventDefault();
            uploadZone.classList.add('border-green-500', 'bg-green-100');
        });

        uploadZone.addEventListener('dragleave', function (e) {
            e.preventDefault();
            uploadZone.classList.remove('border-green-500', 'bg-green-100');
        });

        uploadZone.addEventListener('drop', function (e) {
            e.preventDefault();
            uploadZone.classList.remove('border-green-500', 'bg-green-100');
            const files = e.dataTransfer.files;
            handleIngredientFiles(files);
        });

        // File input change
        fileInput.addEventListener('change', function (e) {
            handleIngredientFiles(e.target.files);
        });
    }

    // Step modal image upload functionality
    function setupStepImageUpload() {
        const uploadZone = document.getElementById('step-upload-zone');
        const uploadArea = document.getElementById('step-upload-area');
        const fileInput = document.getElementById('step-images');
        const preview = document.getElementById('step-image-preview');

        // Click to upload
        uploadArea.addEventListener('click', function () {
            fileInput.click();
        });

        // Drag & drop functionality
        uploadZone.addEventListener('dragover', function (e) {
            e.preventDefault();
            uploadZone.classList.add('border-orange-500', 'bg-orange-100');
        });

        uploadZone.addEventListener('dragleave', function (e) {
            e.preventDefault();
            uploadZone.classList.remove('border-orange-500', 'bg-orange-100');
        });

        uploadZone.addEventListener('drop', function (e) {
            e.preventDefault();
            uploadZone.classList.remove('border-orange-500', 'bg-orange-100');
            const files = e.dataTransfer.files;
            handleStepFiles(files);
        });

        // File input change
        fileInput.addEventListener('change', function (e) {
            handleStepFiles(e.target.files);
        });
    }

    // Handle ingredient image files
    function handleIngredientFiles(files) {
        const preview = document.getElementById('ingredient-image-preview');

        if (files.length === 0) return;

        preview.classList.remove('hidden');
        preview.innerHTML = '';

        Array.from(files).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                // Validate file size (30MB max for modal images)
                if (file.size > 30 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Maximum size is 30MB.`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    createIngredientImagePreview(e.target.result, file.name, index);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Handle step image files
    function handleStepFiles(files) {
        const preview = document.getElementById('step-image-preview');

        if (files.length === 0) return;

        preview.classList.remove('hidden');
        preview.innerHTML = '';

        Array.from(files).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                // Validate file size (30MB max for modal images)
                if (file.size > 30 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Maximum size is 30MB.`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    createStepImagePreview(e.target.result, file.name, index);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Create ingredient image preview
    function createIngredientImagePreview(src, filename, index) {
        const preview = document.getElementById('ingredient-image-preview');
        const previewItem = document.createElement('div');
        previewItem.className = 'relative group image-preview-item';
        previewItem.innerHTML = `
            <div class="relative overflow-hidden rounded-lg shadow-sm border border-green-200 hover:shadow-md transition-all duration-200">
                <img src="${src}" class="w-full h-16 object-cover" alt="${filename}">
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200"></div>
                <button type="button" onclick="removeIngredientImage(${index})"
                    class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 flex items-center justify-center">
                    ×
                </button>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-1">
                    <p class="text-white text-xs truncate font-medium">${filename}</p>
                </div>
            </div>
        `;
        preview.appendChild(previewItem);
    }

    // Create step image preview
    function createStepImagePreview(src, filename, index) {
        const preview = document.getElementById('step-image-preview');
        const previewItem = document.createElement('div');
        previewItem.className = 'relative group image-preview-item';
        previewItem.innerHTML = `
            <div class="relative overflow-hidden rounded-lg shadow-sm border border-orange-200 hover:shadow-md transition-all duration-200">
                <img src="${src}" class="w-full h-16 object-cover" alt="${filename}">
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200"></div>
                <button type="button" onclick="removeStepImage(${index})"
                    class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 flex items-center justify-center">
                    ×
                </button>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-1">
                    <p class="text-white text-xs truncate font-medium">${filename}</p>
                </div>
            </div>
        `;
        preview.appendChild(previewItem);
    }

    // Remove ingredient image
    function removeIngredientImage(index) {
        const preview = document.getElementById('ingredient-image-preview');
        const previewItems = preview.children;
        if (previewItems[index]) {
            previewItems[index].remove();
        }

        // If no images left, hide preview
        if (preview.children.length === 0) {
            preview.classList.add('hidden');
        }
    }

    // Remove step image
    function removeStepImage(index) {
        const preview = document.getElementById('step-image-preview');
        const previewItems = preview.children;
        if (previewItems[index]) {
            previewItems[index].remove();
        }

        // If no images left, hide preview
        if (preview.children.length === 0) {
            preview.classList.add('hidden');
        }
    }

    // Clear modal previews when closing
    function clearIngredientPreviews() {
        const preview = document.getElementById('ingredient-image-preview');
        preview.innerHTML = '';
        preview.classList.add('hidden');
    }

    function clearStepPreviews() {
        const preview = document.getElementById('step-image-preview');
        preview.innerHTML = '';
        preview.classList.add('hidden');
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('add-ingredient-btn').addEventListener('click', openIngredientModal);
        document.getElementById('add-step-btn').addEventListener('click', openStepModal);

        // Setup image upload functionality for modals
        setupIngredientImageUpload();
        setupStepImageUpload();
    });

    // Close modals when clicking outside
    window.addEventListener('click', function (e) {
        if (e.target.classList.contains('bg-black')) {
            closeIngredientModal();
            closeStepModal();
        }
    });

    // Error handling and debug functions
    function showErrorMessage(title, errors) {
        // Remove existing error message
        clearErrorMessages();

        const errorDiv = document.createElement('div');
        errorDiv.id = 'error-message';
        errorDiv.className = 'fixed top-4 right-4 bg-red-50 border border-red-200 rounded-lg p-4 shadow-lg z-50 max-w-md';
        errorDiv.innerHTML = `
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">${title}</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <ul class="list-disc pl-5 space-y-1">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                <div class="ml-auto pl-3">
                    <div class="-mx-1.5 -my-1.5">
                        <button type="button" class="inline-flex bg-red-50 rounded-md p-1.5 text-red-500 hover:bg-red-100" onclick="clearErrorMessages()">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(errorDiv);

        // Auto-remove after 10 seconds
        setTimeout(() => {
            clearErrorMessages();
        }, 10000);
    }

    function clearErrorMessages() {
        const existingError = document.getElementById('error-message');
        if (existingError) {
            existingError.remove();
        }
    }

    function showDebugInfo() {
        // Remove existing debug info
        clearDebugInfo();

        const debugDiv = document.createElement('div');
        debugDiv.id = 'debug-info';
        debugDiv.className = 'fixed bottom-4 left-4 bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-lg z-50 max-w-md';

        // Get hidden fields for debugging
        const form = document.getElementById('recipe-form');
        const ingredientFields = form.querySelectorAll('[name*="ingredients-"]');
        const stepFields = form.querySelectorAll('[name*="steps-"]');

        debugDiv.innerHTML = `
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-bug text-blue-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-800">Debug Information</h3>
                    <div class="mt-2 text-xs text-blue-700 space-y-1">
                        <div><strong>Ingredients:</strong> ${ingredients.length} (${ingredientFields.length} hidden fields)</div>
                        <div><strong>Steps:</strong> ${steps.length} (${stepFields.length} hidden fields)</div>
                        <div><strong>Recipe Images:</strong> ${document.getElementById('recipe-images').files.length} files</div>
                        <div><strong>Form Action:</strong> ${document.getElementById('recipe-form').action}</div>
                        <div><strong>Form Method:</strong> ${document.getElementById('recipe-form').method}</div>
                        <div class="mt-2">
                            <button type="button" class="text-blue-600 hover:text-blue-800 underline text-xs" onclick="showFullDebugInfo()">
                                Show Full Debug Info
                            </button>
                        </div>
                    </div>
                </div>
                <div class="ml-auto pl-3">
                    <div class="-mx-1.5 -my-1.5">
                        <button type="button" class="inline-flex bg-blue-50 rounded-md p-1.5 text-blue-500 hover:bg-blue-100" onclick="clearDebugInfo()">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(debugDiv);

        // Auto-remove after 15 seconds
        setTimeout(() => {
            clearDebugInfo();
        }, 15000);
    }

    function clearDebugInfo() {
        const existingDebug = document.getElementById('debug-info');
        if (existingDebug) {
            existingDebug.remove();
        }
    }

    function showFullDebugInfo() {
        const form = document.getElementById('recipe-form');
        const allFields = form.querySelectorAll('input[type="hidden"]');

        let debugInfo = '=== FULL DEBUG INFORMATION ===\n\n';
        debugInfo += `Ingredients Array (${ingredients.length}):\n`;
        ingredients.forEach((ing, i) => {
            debugInfo += `  ${i}: ${JSON.stringify(ing, null, 2)}\n`;
        });

        debugInfo += `\nSteps Array (${steps.length}):\n`;
        steps.forEach((step, i) => {
            debugInfo += `  ${i}: ${JSON.stringify(step, null, 2)}\n`;
        });

        debugInfo += `\nHidden Form Fields (${allFields.length}):\n`;
        allFields.forEach((field, i) => {
            debugInfo += `  ${field.name} = "${field.value}"\n`;
        });

        debugInfo += `\nForm Data:\n`;
        const formData = new FormData(document.getElementById('recipe-form'));
        for (let [key, value] of formData.entries()) {
            debugInfo += `  ${key} = "${value}"\n`;
        }

        console.log(debugInfo);

        // Also show in a modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-96 overflow-auto p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Full Debug Information</h3>
                    <button type="button" class="text-gray-400 hover:text-gray-600" onclick="this.closest('.fixed').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <pre class="text-xs bg-gray-100 p-4 rounded overflow-auto max-h-80">${debugInfo}</pre>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Check for flash messages and display them
    window.addEventListener('DOMContentLoaded', function () {
        // Check if there are any flash messages from the server
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(message => {
            const type = message.classList.contains('error') ? 'error' : 'success';
            const title = type === 'error' ? 'Server Error' : 'Success';
            const text = message.textContent.trim();

            if (type === 'error') {
                showErrorMessage(title, [text]);
            }
        });
    });
</script>

{% endblock %}
