{% extends "dashboard/base.html" %}

{% block title %}Add Recipe{% endblock %}

{% block dashboard_content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Add a New Recipe</h1>

    <form method="POST" action="{{ url_for('dashboard.add_recipe') }}" enctype="multipart/form-data" class="space-y-6">
        {{ form.hidden_tag() }}

        <div>
            {{ form.name.label(class="block text-sm font-medium text-gray-700") }}
            {{ form.name(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm") }}
        </div>

        <div>
            {{ form.description.label(class="block text-sm font-medium text-gray-700") }}
            {{ form.description(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", rows=4) }}
        </div>

        <div class="flex items-center">
            {{ form.public(class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500") }}
            {{ form.public.label(class="ml-2 block text-sm text-gray-900") }}
        </div>

        <div>
            {{ form.category_id.label(class="block text-sm font-medium text-gray-700") }}
            {{ form.category_id(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm") }}
        </div>

        <div>
            {{ form.origin_id.label(class="block text-sm font-medium text-gray-700") }}
            {{ form.origin_id(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm") }}
        </div>

        <div>
            {{ form.recipe_images.label(class="block text-sm font-medium text-gray-700") }}
            {{ form.recipe_images(class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none", multiple=True, onchange="previewImages(event)") }}
            <div id="image-preview" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>

        <div id="ingredients-container" data-index="{{ form.ingredients|length }}">
            <h2 class="text-xl font-bold mb-4">Ingredients</h2>
            {% for ingredient_field in form.ingredients %}
            <div class="ingredient-form grid grid-cols-4 gap-4 mb-4">
                {{ ingredient_field.form.name.label(class="hidden") }}
                {{ ingredient_field.form.name(class="col-span-2 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", placeholder="Name") }}
                {{ ingredient_field.form.quantity.label(class="hidden") }}
                {{ ingredient_field.form.quantity(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", placeholder="Quantity") }}
                {{ ingredient_field.form.unit.label(class="hidden") }}
                {{ ingredient_field.form.unit(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", placeholder="Unit") }}
            </div>
            {% endfor %}
        </div>
        <button type="button" id="add-ingredient" class="text-indigo-600 hover:text-indigo-900">Add Ingredient</button>

        <div id="steps-container" data-index="{{ form.steps|length }}">
            <h2 class="text-xl font-bold mb-4">Steps</h2>
            {% for step_field in form.steps %}
            <div class="step-form grid grid-cols-1 gap-4 mb-4">
                {{ step_field.form.step_number.label(class="hidden") }}
                {{ step_field.form.step_number(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", placeholder="Step Number") }}
                {{ step_field.form.instruction.label(class="hidden") }}
                {{ step_field.form.instruction(class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", placeholder="Instruction", rows=2) }}
            </div>
            {% endfor %}
        </div>
        <button type="button" id="add-step" class="text-indigo-600 hover:text-indigo-900">Add Step</button>

        <div id="ingredient-template" style="display: none;">
            <div class="ingredient-form grid grid-cols-4 gap-4 mb-4">
                <input class="col-span-2 mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Name" type="text" name="ingredients-__prefix__-name" value="">
                <input class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Quantity" type="text" name="ingredients-__prefix__-quantity" value="">
                <input class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Unit" type="text" name="ingredients-__prefix__-unit" value="">
            </div>
        </div>

        <div id="step-template" style="display: none;">
            <div class="step-form grid grid-cols-1 gap-4 mb-4">
                <input class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Step Number" type="text" name="steps-__prefix__-step_number" value="">
                <textarea class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Instruction" rows="2" name="steps-__prefix__-instruction"></textarea>
            </div>
        </div>

        <div>
            {{ form.submit(class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2") }}
        </div>
    </form>
</div>

<script>
    function previewImages(event) {
        const previewContainer = document.getElementById('image-preview');
        previewContainer.innerHTML = '';
        for (const file of event.target.files) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'h-32 w-full object-cover rounded-md';
                previewContainer.appendChild(img);
            }
            reader.readAsDataURL(file);
        }
    }

    document.getElementById('add-ingredient').addEventListener('click', function() {
        const container = document.getElementById('ingredients-container');
        let index = parseInt(container.getAttribute('data-index'));
        const template = document.getElementById('ingredient-template').innerHTML;
        const newField = template.replace(/__prefix__/g, index);
        container.insertAdjacentHTML('beforeend', newField);
        container.setAttribute('data-index', index + 1);
    });

    document.getElementById('add-step').addEventListener('click', function() {
        const container = document.getElementById('steps-container');
        let index = parseInt(container.getAttribute('data-index'));
        const template = document.getElementById('step-template').innerHTML;
        const newField = template.replace(/__prefix__/g, index);
        const newElement = document.createElement('div');
        newElement.innerHTML = newField;
        const stepNumberInput = newElement.querySelector(`[name="steps-${index}-step_number"]`);
        if (stepNumberInput) {
            stepNumberInput.value = index + 1;
        }
        container.insertAdjacentHTML('beforeend', newElement.innerHTML);
        container.setAttribute('data-index', index + 1);
    });
</script>
{% endblock dashboard_content %}
