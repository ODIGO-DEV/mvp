{% extends "dashboard/base.html" %}
{% block title %}Community Feed - ODiGO{% endblock %}
{% block page_title %}Community Feed{% endblock %}
{% block dashboard_content %}

<!-- Header Section -->
<section
    class="bg-gradient-to-r from-indigo-700 to-purple-600 text-white rounded-2xl p-6 sm:p-8 mb-6 relative overflow-hidden">
    <div class="absolute inset-0 opacity-10">
        <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
            <pattern id="pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                <circle cx="10" cy="10" r="1" fill="white" />
            </pattern>
            <rect width="100%" height="100%" fill="url(#pattern)" />
        </svg>
    </div>
    <div class="relative z-10 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center">
            <div class="bg-white/20 border border-white/30 backdrop-blur-sm rounded-full p-3 mr-4">
                <i class="fa-solid fa-users text-2xl"></i>
            </div>
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold">Community Feed</h1>
                <p class="text-indigo-100 text-sm sm:text-base mt-1">Share recipes, tips, and connect with fellow food
                    lovers</p>
            </div>
        </div>
        <div class="bg-white/20 border border-white/30 backdrop-blur-sm px-5 py-3 rounded-xl text-center">
            <div class="text-2xl font-bold text-yellow-300">{{ (posts|length + recipes|length) }}</div>
            <p class="text-xs text-indigo-100">Recent Posts</p>
        </div>
    </div>
</section>

<!-- Quick Stats -->
<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-6">
    {% set total_comments = 0 %}
    {% for recipe in recipes %}
    {% if recipe.comments %}
    {% set total_comments = total_comments + recipe.comments|length %}
    {% endif %}
    {% endfor %}

    {% set stats = [
    {'color': 'from-green-500 to-emerald-600', 'title': 'Recipes', 'icon': 'fa-solid fa-utensils', 'count':
    recipes|length},
    {'color': 'from-blue-500 to-indigo-600', 'title': 'Posts', 'icon': 'fa-solid fa-pen', 'count': posts|length},
    {'color': 'from-purple-500 to-fuchsia-600', 'title': 'Comments', 'icon': 'fa-solid fa-comments', 'count':
    total_comments},
    {'color': 'from-orange-500 to-yellow-500', 'title': 'Active', 'icon': 'fa-solid fa-fire', 'count': 'Now'}
    ] %}
    {% for stat in stats %}
    <div class="p-4 rounded-xl bg-gradient-to-br {{ stat.color }} text-white text-center">
        <div class="bg-white/20 w-10 h-10 flex items-center justify-center rounded-lg mx-auto mb-2">
            <i class="{{ stat.icon }} w-5 h-5"></i>
        </div>
        <div class="font-semibold text-sm">{{ stat.title }}</div>
        <div class="text-xs text-white/80 mt-0.5">{{ stat.count }}</div>
    </div>
    {% endfor %}
</div>

<!-- Filters and Search -->
<div class="bg-white rounded-xl p-6 border border-gray-200 mb-6 shadow-sm">
    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
        <div class="flex flex-wrap gap-2">
            <button class="filter-btn active" data-filter="all">
                <i class="fa-solid fa-globe mr-2"></i>All Posts
            </button>
            <button class="filter-btn" data-filter="recipes">
                <i class="fa-solid fa-utensils mr-2"></i>Recipes
            </button>
            <button class="filter-btn" data-filter="posts">
                <i class="fa-solid fa-pen mr-2"></i>Discussions
            </button>
            <button class="filter-btn" data-filter="trending">
                <i class="fa-solid fa-fire mr-2"></i>Trending
            </button>
        </div>
        <div class="flex items-center gap-3 w-full sm:w-auto">
            <div class="relative flex-1 sm:flex-none">
                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="feed-search" placeholder="Search posts..."
                    class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button id="create-post-btn"
                class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-lg hover:from-indigo-700 hover:to-indigo-800 transition-all whitespace-nowrap">
                <i class="fa-solid fa-plus mr-2"></i>Create Post
            </button>
        </div>
    </div>
</div>

<!-- Post Creation Modal -->
<div id="create-post-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4 shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center">
                <div
                    class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full w-12 h-12 flex items-center justify-center mr-4">
                    {{ (current_user.name or 'U')[0].upper() }}
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Share with the Community</h2>
                    <p class="text-sm text-gray-500">What's cooking, {{ current_user.name or 'Chef' }}?</p>
                </div>
            </div>
            <button class="text-gray-400 hover:text-gray-600 text-2xl font-bold" id="close-create-modal">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>

        <form method="POST" action="{{ url_for('community.feed') }}" class="space-y-6">
            {{ post_form.hidden_tag() }}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Post Title</label>
                {{ post_form.title(class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2
                focus:ring-indigo-500 focus:border-indigo-500 transition-colors", placeholder="What's the title of your
                post?") }}
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Share your thoughts</label>
                {{ post_form.content(class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2
                focus:ring-indigo-500 focus:border-indigo-500 transition-colors resize-none", rows=6, placeholder="Share
                your thoughts, cooking tips, or ask the community a question...") }}
                <p class="text-xs text-gray-500 mt-1">Be respectful and helpful to fellow community members</p>
            </div>

            <div class="flex justify-between items-center pt-4 border-t">
                <div class="flex items-center space-x-3">
                    <button type="button"
                        class="text-gray-400 hover:text-indigo-600 transition-colors p-2 rounded-lg hover:bg-gray-100">
                        <i class="fa-solid fa-image text-lg"></i>
                    </button>
                    <button type="button"
                        class="text-gray-400 hover:text-indigo-600 transition-colors p-2 rounded-lg hover:bg-gray-100">
                        <i class="fa-solid fa-smile text-lg"></i>
                    </button>
                    <button type="button"
                        class="text-gray-400 hover:text-indigo-600 transition-colors p-2 rounded-lg hover:bg-gray-100">
                        <i class="fa-solid fa-hashtag text-lg"></i>
                    </button>
                </div>
                <div class="flex gap-3">
                    <button type="button" class="px-4 py-2 text-gray-600 hover:text-gray-800" id="cancel-create-post">
                        Cancel
                    </button>
                    {{ post_form.submit(class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white
                    rounded-lg font-medium hover:from-indigo-700 hover:to-indigo-800 transition-all transform
                    hover:scale-105") }}
                </div>
            </div>
        </form>
    </div>
</div>

{% set feed_items = (posts + recipes)|sort(attribute='created_at', reverse=True) %}

<!-- Feed Content -->
<div id="feed-container" class="space-y-6">
    {% if feed_items %}
    {% for item in feed_items %}
    {% if item.__class__.__name__ == 'Post' %}
    <!-- Discussion Post -->
    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300 feed-item discussion-post"
        data-type="post">
        <!-- Post Header -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
                <div
                    class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full w-12 h-12 flex items-center justify-center font-semibold">
                    {{ (item.author.name or 'U')[0].upper() }}
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800">{{ item.author.name or 'Chef' }}</h4>
                    <div class="flex items-center text-sm text-gray-500 space-x-2">
                        <span>{{ item.created_at.strftime('%b %d, %Y') }}</span>
                        <span>•</span>
                        <span class="flex items-center">
                            <i class="fa-solid fa-pen mr-1"></i>
                            Discussion
                        </span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100">
                    <i class="fa-solid fa-bookmark"></i>
                </button>
                <button class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100">
                    <i class="fa-solid fa-ellipsis"></i>
                </button>
            </div>
        </div>

        <!-- Post Content -->
        <div class="mb-4">
            <h3 class="text-xl font-bold text-gray-800 mb-3">{{ item.title }}</h3>
            <div class="text-gray-700 leading-relaxed">
                {% set content_preview = item.content[:200] %}
                <p id="content-preview-{{ loop.index }}"
                    class="{% if item.content|length > 200 %}line-clamp-3{% endif %}">
                    {{ content_preview }}{% if item.content|length > 200 %}...{% endif %}
                </p>
                {% if item.content|length > 200 %}
                <div id="content-full-{{ loop.index }}" class="hidden">
                    {{ item.content }}
                </div>
                <button class="text-indigo-600 hover:text-indigo-800 text-sm font-medium mt-2 read-more-btn"
                    data-target="{{ loop.index }}">
                    Read More
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Post Actions -->
        <div class="flex items-center justify-between pt-4 border-t border-gray-100">
            <div class="flex items-center space-x-6">
                <button class="flex items-center space-x-2 text-gray-500 hover:text-indigo-600 transition-colors">
                    <i class="fa-solid fa-heart"></i>
                    <span class="text-sm">Like</span>
                </button>
                <button class="flex items-center space-x-2 text-gray-500 hover:text-indigo-600 transition-colors">
                    <i class="fa-solid fa-comment"></i>
                    <span class="text-sm">Comment</span>
                </button>
                <button class="flex items-center space-x-2 text-gray-500 hover:text-indigo-600 transition-colors">
                    <i class="fa-solid fa-share"></i>
                    <span class="text-sm">Share</span>
                </button>
            </div>
            <div class="text-xs text-gray-400">
                {{ item.created_at.strftime('%H:%M') }}
            </div>
        </div>
    </div>
    {% elif item.__class__.__name__ == 'Recipe' %}
    <!-- Recipe Post -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all duration-300 feed-item recipe-post"
        data-type="recipe">
        <!-- Recipe Image -->
        {% if item.images %}
        <div class="relative">
            <img src="{{ item.images[0].url }}" alt="{{ item.name }}" class="w-full h-56 object-cover rounded-t-xl">
            <div class="absolute top-4 right-4">
                <div
                    class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-3 py-1 rounded-full text-xs font-medium flex items-center">
                    <i class="fa-solid fa-utensils mr-1"></i>
                    Recipe
                </div>
            </div>
        </div>
        {% else %}
        <div
            class="w-full h-56 bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center rounded-t-xl">
            <div class="text-center text-white">
                <i class="fa-solid fa-utensils text-4xl mb-2"></i>
                <p class="text-sm font-medium">{{ item.name }}</p>
            </div>
        </div>
        {% endif %}

        <div class="p-6">
            <!-- Recipe Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div
                        class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white rounded-full w-12 h-12 flex items-center justify-center font-semibold">
                        {{ (item.author.name or 'U')[0].upper() }}
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">{{ item.author.name or 'Chef' }}</h4>
                        <div class="flex items-center text-sm text-gray-500 space-x-2">
                            <span>{{ item.created_at.strftime('%b %d, %Y') }}</span>
                            <span>•</span>
                            <span>{{ item.origin.country if item.origin else 'Global' }}</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100">
                        <i class="fa-solid fa-bookmark"></i>
                    </button>
                    <button class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100">
                        <i class="fa-solid fa-ellipsis"></i>
                    </button>
                </div>
            </div>

            <!-- Recipe Content -->
            <div class="mb-4">
                <h3 class="text-xl font-bold text-gray-800 mb-2">{{ item.name }}</h3>

                <!-- Recipe Meta -->
                <div class="flex flex-wrap gap-2 mb-3">
                    {% if item.category %}
                    <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs font-medium">
                        {{ item.category.name }}
                    </span>
                    {% endif %}
                    {% if item.prep_time %}
                    <span
                        class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium flex items-center">
                        <i class="fa-solid fa-clock mr-1"></i>
                        {{ item.prep_time }} min
                    </span>
                    {% endif %}
                    {% if item.servings %}
                    <span
                        class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium flex items-center">
                        <i class="fa-solid fa-users mr-1"></i>
                        {{ item.servings }} servings
                    </span>
                    {% endif %}
                </div>

                <p class="text-gray-700 leading-relaxed mb-4">{{ item.description | truncate(120, True, '...') }}</p>
            </div>

            <!-- Recipe Actions -->
            <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                <div class="flex items-center space-x-6">
                    <button class="flex items-center space-x-2 text-gray-500 hover:text-orange-600 transition-colors">
                        <i class="fa-solid fa-heart"></i>
                        <span class="text-sm">Save</span>
                    </button>
                    <button class="flex items-center space-x-2 text-gray-500 hover:text-orange-600 transition-colors">
                        <i class="fa-solid fa-comment"></i>
                        <span class="text-sm">{{ item.comments|length if item.comments else 0 }}</span>
                    </button>
                    <button class="flex items-center space-x-2 text-gray-500 hover:text-orange-600 transition-colors">
                        <i class="fa-solid fa-share"></i>
                        <span class="text-sm">Share</span>
                    </button>
                </div>
                <a href="{{ url_for('dashboard.view_recipe', recipe_id=item.id) }}"
                    class="px-4 py-2 bg-gradient-to-r from-orange-600 to-yellow-600 text-white rounded-lg font-medium hover:from-orange-700 hover:to-yellow-700 transition-all transform hover:scale-105">
                    View Recipe
                </a>
            </div>

            <!-- Comments Section (Expandable) -->
            {% if item.comments %}
            <div class="mt-6 pt-4 border-t border-gray-100">
                <button class="text-gray-600 hover:text-gray-800 text-sm font-medium mb-3 comment-toggle"
                    data-recipe-id="{{ item.id }}">
                    <i class="fa-solid fa-chevron-down mr-1"></i>
                    View {{ item.comments|length }} comment{{ 's' if item.comments|length != 1 else '' }}
                </button>

                <div class="comments-section hidden" id="comments-{{ item.id }}">
                    <!-- Add Comment Form -->
                    <form method="post" action="{{ url_for('community.feed') }}"
                        class="flex items-center space-x-2 mb-4">
                        {{ comment_form.hidden_tag() }}
                        <input type="hidden" name="recipe_id" value="{{ item.id }}">
                        <div
                            class="bg-gradient-to-r from-orange-500 to-yellow-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-xs font-semibold">
                            {{ (current_user.name or 'U')[0].upper() }}
                        </div>
                        {{ comment_form.comment_text(class="flex-1 border border-gray-300 rounded-lg py-2 px-3 text-sm
                        focus:ring-2 focus:ring-orange-500 focus:border-orange-500", placeholder="Add a comment...") }}
                        {{ comment_form.submit(class="px-4 py-2 bg-gradient-to-r from-orange-600 to-yellow-600
                        text-white rounded-lg text-sm font-medium hover:from-orange-700 hover:to-yellow-700
                        transition-all") }}
                    </form>

                    <!-- Comments List -->
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        {% for c in item.comments|sort(attribute='created_at', reverse=True) %}
                        <div class="flex items-start space-x-3">
                            <div
                                class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-xs font-semibold flex-shrink-0">
                                {{ (c.author.name or 'U')[0].upper() }}
                            </div>
                            <div class="flex-1 bg-gray-50 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-1">
                                    <p class="font-semibold text-gray-800 text-sm">{{ c.author.name or 'Anonymous' }}
                                    </p>
                                    <p class="text-xs text-gray-500">{{ c.created_at.strftime('%b %d, %H:%M') }}</p>
                                </div>
                                <p class="text-gray-700 text-sm">{{ c.comment_text }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% endfor %}
    {% else %}
    <!-- Empty State -->
    <div class="bg-white rounded-xl p-12 border border-gray-200 shadow-sm text-center">
        <div
            class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
            <i class="fa-solid fa-users text-3xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-3">Welcome to the Community!</h3>
        <p class="text-gray-600 mb-6 max-w-md mx-auto">
            Share your culinary creations, discover new recipes, and connect with fellow food enthusiasts.
        </p>
        <button id="create-first-post-btn"
            class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-lg font-medium hover:from-indigo-700 hover:to-indigo-800 transition-all transform hover:scale-105">
            <i class="fa-solid fa-plus mr-2"></i>Create Your First Post
        </button>
    </div>
    {% endif %}

    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loading-indicator">
        <div class="flex items-center justify-center space-x-2">
            <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        </div>
        <p class="text-gray-500 mt-2">Loading more posts...</p>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .filter-btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #4B5563;
        background-color: #F3F4F6;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        border: none;
        cursor: pointer;
    }

    .filter-btn:hover {
        background-color: #E5E7EB;
    }

    .filter-btn.active {
        background: linear-gradient(to right, #4F46E5, #3730A3);
        color: white;
    }

    .feed-item {
        transform: translateY(0);
        transition: all 0.3s ease;
    }

    .feed-item:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .animate-pulse-subtle {
        animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse-subtle {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.8;
        }
    }

    /* Smooth transitions for interactions */
    .feed-item .heart-animation {
        transition: transform 0.2s ease, color 0.2s ease;
    }

    .feed-item .heart-animation:hover {
        transform: scale(1.1);
    }

    /* Enhanced modal animations */
    #create-post-modal {
        backdrop-filter: blur(4px);
    }

    #create-post-modal>div {
        animation: modal-slide-in 0.3s ease-out;
    }

    @keyframes modal-slide-in {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Custom scrollbar for comments */
    .comments-section {
        scrollbar-width: thin;
        scrollbar-color: #CBD5E0 #F7FAFC;
    }

    .comments-section::-webkit-scrollbar {
        width: 6px;
    }

    .comments-section::-webkit-scrollbar-track {
        background: #F7FAFC;
        border-radius: 3px;
    }

    .comments-section::-webkit-scrollbar-thumb {
        background: #CBD5E0;
        border-radius: 3px;
    }

    .comments-section::-webkit-scrollbar-thumb:hover {
        background: #A0AEC0;
    }

    /* Loading state for infinite scroll */
    .loading-indicator {
        display: none;
        text-align: center;
        padding: 2rem;
        color: #6B7280;
    }

    .loading-indicator.show {
        display: block;
    }

    /* Improved textarea auto-resize */
    textarea {
        resize: none;
        overflow: hidden;
        min-height: 100px;
    }

    /* Enhanced button hover effects */
    .action-button {
        transition: all 0.2s ease;
    }

    .action-button:hover {
        transform: translateY(-1px);
    }

    /* Recipe card enhancements */
    .recipe-meta-tag {
        transition: all 0.2s ease;
    }

    .recipe-meta-tag:hover {
        transform: scale(1.05);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Modal functionality
        const createPostBtn = document.getElementById('create-post-btn');
        const createFirstPostBtn = document.getElementById('create-first-post-btn');
        const createPostModal = document.getElementById('create-post-modal');
        const closeCreateModal = document.getElementById('close-create-modal');
        const cancelCreatePost = document.getElementById('cancel-create-post');

        function openCreatePostModal() {
            if (createPostModal) {
                createPostModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // Focus on the title input
                const titleInput = createPostModal.querySelector('input[name="title"]');
                if (titleInput) {
                    setTimeout(() => titleInput.focus(), 100);
                }
            }
        }

        if (createPostBtn) {
            createPostBtn.addEventListener('click', openCreatePostModal);
        }

        if (createFirstPostBtn) {
            createFirstPostBtn.addEventListener('click', openCreatePostModal);
        }

        function closeModal() {
            if (createPostModal) {
                createPostModal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        if (closeCreateModal) {
            closeCreateModal.addEventListener('click', closeModal);
        }

        if (cancelCreatePost) {
            cancelCreatePost.addEventListener('click', closeModal);
        }

        // Close modal when clicking outside
        if (createPostModal) {
            createPostModal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        // Filter functionality
        const filterBtns = document.querySelectorAll('.filter-btn');
        const feedItems = document.querySelectorAll('.feed-item');

        filterBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const filter = this.dataset.filter;

                // Update active button
                filterBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Filter items
                feedItems.forEach(item => {
                    const itemType = item.dataset.type;

                    if (filter === 'all') {
                        item.style.display = '';
                    } else if (filter === 'recipes' && itemType === 'recipe') {
                        item.style.display = '';
                    } else if (filter === 'posts' && itemType === 'post') {
                        item.style.display = '';
                    } else if (filter === 'trending') {
                        // For now, show all items for trending
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });

        // Search functionality
        const searchInput = document.getElementById('feed-search');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = this.value.toLowerCase();

                    feedItems.forEach(item => {
                        const title = item.querySelector('h3')?.textContent.toLowerCase() || '';
                        const content = item.querySelector('p')?.textContent.toLowerCase() || '';
                        const author = item.querySelector('h4')?.textContent.toLowerCase() || '';

                        if (title.includes(searchTerm) || content.includes(searchTerm) || author.includes(searchTerm)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                }, 300);
            });
        }

        // Read more functionality
        const readMoreBtns = document.querySelectorAll('.read-more-btn');
        readMoreBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const target = this.dataset.target;
                const preview = document.getElementById(`content-preview-${target}`);
                const full = document.getElementById(`content-full-${target}`);

                if (preview && full) {
                    if (preview.style.display === 'none') {
                        preview.style.display = '';
                        full.style.display = 'none';
                        this.textContent = 'Read More';
                    } else {
                        preview.style.display = 'none';
                        full.style.display = '';
                        this.textContent = 'Show Less';
                    }
                }
            });
        });

        // Comment toggle functionality
        const commentToggles = document.querySelectorAll('.comment-toggle');
        commentToggles.forEach(toggle => {
            toggle.addEventListener('click', function () {
                const recipeId = this.dataset.recipeId;
                const commentsSection = document.getElementById(`comments-${recipeId}`);
                const icon = this.querySelector('i');

                if (commentsSection) {
                    if (commentsSection.classList.contains('hidden')) {
                        commentsSection.classList.remove('hidden');
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        commentsSection.classList.add('hidden');
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                }
            });
        });

        // Like button animation
        const likeButtons = document.querySelectorAll('button:has(.fa-heart)');
        likeButtons.forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                const heart = this.querySelector('.fa-heart');
                if (heart) {
                    heart.classList.add('animate-pulse-subtle');
                    setTimeout(() => {
                        heart.classList.remove('animate-pulse-subtle');
                    }, 600);
                }
            });
        });

        // Infinite scroll (placeholder)
        let loading = false;
        window.addEventListener('scroll', function () {
            if (loading) return;

            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;

            if (scrollTop + clientHeight >= scrollHeight - 5) {
                // Placeholder for loading more content
                console.log('Load more content...');
            }
        });

        // Auto-resize textarea and character count
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.addEventListener('input', function () {
                // Auto-resize
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';

                // Character count (if in modal)
                if (this.name === 'content') {
                    const charCount = this.value.length;
                    const maxChars = 2000;
                    let countDisplay = this.parentNode.querySelector('.char-count');

                    if (!countDisplay) {
                        countDisplay = document.createElement('div');
                        countDisplay.className = 'char-count text-xs text-gray-500 mt-1 text-right';
                        this.parentNode.appendChild(countDisplay);
                    }

                    countDisplay.textContent = `${charCount}/${maxChars}`;
                    countDisplay.style.color = charCount > maxChars * 0.9 ? '#EF4444' : '#6B7280';
                }
            });
        });

        // Enhanced interaction feedback
        const interactionButtons = document.querySelectorAll('button[class*="hover:"]');
        interactionButtons.forEach(btn => {
            btn.addEventListener('mousedown', function () {
                this.style.transform = 'scale(0.95)';
            });

            btn.addEventListener('mouseup', function () {
                this.style.transform = '';
            });

            btn.addEventListener('mouseleave', function () {
                this.style.transform = '';
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // Ctrl/Cmd + Enter to submit post
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const modal = document.getElementById('create-post-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    const submitBtn = modal.querySelector('input[type="submit"]');
                    if (submitBtn) {
                        submitBtn.click();
                    }
                }
            }

            // Escape to close modal
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Toast notification system
        function showToast(message, type = 'info') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());

            const toast = document.createElement('div');
            toast.className = `toast fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full`;

            // Set color based on type
            switch (type) {
                case 'success':
                    toast.classList.add('bg-green-500');
                    break;
                case 'error':
                    toast.classList.add('bg-red-500');
                    break;
                case 'warning':
                    toast.classList.add('bg-yellow-500');
                    break;
                default:
                    toast.classList.add('bg-indigo-500');
            }

            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fa-solid ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation' : type === 'warning' ? 'fa-warning' : 'fa-info'}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);

            // Auto remove
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Enhanced form validation
        const postForm = document.querySelector('#create-post-modal form');
        if (postForm) {
            postForm.addEventListener('submit', function (e) {
                const titleInput = this.querySelector('input[name="title"]');
                const contentInput = this.querySelector('textarea[name="content"]');

                if (!titleInput.value.trim()) {
                    e.preventDefault();
                    showToast('Please enter a title for your post', 'error');
                    titleInput.focus();
                    return;
                }

                if (!contentInput.value.trim()) {
                    e.preventDefault();
                    showToast('Please add some content to your post', 'error');
                    contentInput.focus();
                    return;
                }

                if (contentInput.value.length > 2000) {
                    e.preventDefault();
                    showToast('Post content is too long (maximum 2000 characters)', 'error');
                    contentInput.focus();
                    return;
                }

                // Show loading state
                const submitBtn = this.querySelector('input[type="submit"]');
                const originalText = submitBtn.value;
                submitBtn.value = 'Posting...';
                submitBtn.disabled = true;

                // Re-enable after a delay (in case of network issues)
                setTimeout(() => {
                    submitBtn.value = originalText;
                    submitBtn.disabled = false;
                }, 5000);
            });
        }

        // Like button with optimistic updates
        document.querySelectorAll('button').forEach(btn => {
            if (btn.querySelector('.fa-heart')) {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();

                    const heart = this.querySelector('.fa-heart');
                    const isLiked = heart.classList.contains('fa-solid');

                    // Toggle heart state
                    if (isLiked) {
                        heart.classList.remove('fa-solid');
                        heart.classList.add('fa-regular');
                        heart.style.color = '';
                    } else {
                        heart.classList.remove('fa-regular');
                        heart.classList.add('fa-solid');
                        heart.style.color = '#EF4444';

                        // Animate
                        heart.style.transform = 'scale(1.3)';
                        setTimeout(() => {
                            heart.style.transform = '';
                        }, 200);
                    }

                    // In a real app, you'd send an API request here
                    // showToast(isLiked ? 'Post unliked' : 'Post liked', 'success');
                });
            }
        });

        // Smooth scroll to new posts (if any)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('new_post')) {
            showToast('Your post has been shared with the community!', 'success');
            // Remove the parameter from URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    });
</script>
{% endblock %}
