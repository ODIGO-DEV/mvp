{% extends "dashboard/base.html" %}
{% block title %}Meal Planner - ODiGO{% endblock %}
{% block dashboard_content %}
<div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-8 text-white mb-6">
  <div class="flex items-center">
    <div class="bg-white bg-opacity-20 rounded-full p-3 mr-4">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2v-7H3v7a2 2 0 002 2z"/></svg>
    </div>
    <div>
      <h1 class="text-3xl font-bold mb-1">Meal Planner</h1>
      <p class="text-indigo-100">Plan breakfast, lunch and dinner, see macros, and generate your grocery list.</p>
    </div>
  </div>
</div>

<div class="bg-white rounded-xl p-6 border border-gray-200 card">
  <form method="get" class="mb-4">
    <label class="mr-2">Date</label>
    <input type="date" name="date" value="{{ selected_date.isoformat() }}" class="border p-2 rounded">
    <button class="ml-2 px-4 py-2 bg-indigo-600 text-white rounded">Go</button>
  </form>

  <form method="post" class="space-y-4">
    {{ form.hidden_tag() }}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      {% set meal_types = ['breakfast','lunch','dinner'] %}
      {% for mt in meal_types %}
      <div class="border rounded-lg p-4">
        <div class="flex items-center mb-2">
          <span class="badge badge-info capitalize mr-2">{{ mt }}</span>
          {% if entries.get(mt) %}
          <span class="text-xs text-gray-500">currently: {{ entries.get(mt).recipe.name }}</span>
          {% endif %}
        </div>
        <input type="hidden" name="{{ mt }}_recipe_id" id="{{ mt }}_recipe_id" value="{{ entries.get(mt).recipe_id if entries.get(mt) else '' }}">
        <button type="button" class="w-full border rounded p-2 bg-gray-100 hover:bg-gray-200" onclick="openModal('{{ mt }}')">Select Recipe</button>
      </div>
      {% endfor %}
    </div>
    <div class="text-right">
      {{ form.submit(class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded") }}
    </div>
  </form>

  <hr class="my-6">
  <h2 class="text-xl font-semibold mb-3">Daily Nutrition</h2>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
    <div class="p-3 bg-indigo-50 rounded"><span class="text-sm text-indigo-700">Protein</span><div class="text-lg font-semibold">{{ '%.1f' % totals.protein }} g</div></div>
    <div class="p-3 bg-blue-50 rounded"><span class="text-sm text-blue-700">Carbs</span><div class="text-lg font-semibold">{{ '%.1f' % totals.carbs }} g</div></div>
    <div class="p-3 bg-purple-50 rounded"><span class="text-sm text-purple-700">Fats</span><div class="text-lg font-semibold">{{ '%.1f' % totals.fats }} g</div></div>
    <div class="p-3 bg-green-50 rounded"><span class="text-sm text-green-700">Calories</span><div class="text-lg font-semibold">{{ '%.0f' % totals.calories }}</div></div>
  </div>

  <div class="mt-6">
    <a class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded" href="{{ url_for('planner.grocery_list', date=selected_date.isoformat()) }}">Generate Grocery List</a>
    <a class="ml-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-fuchsia-600 text-white rounded" href="{{ url_for('planner.suggestions', goal='high_protein') }}">REMii: High Protein</a>
    <a class="ml-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-fuchsia-600 text-white rounded" href="{{ url_for('planner.suggestions', goal='low_carb') }}">REMii: Low Carb</a>
  </div>
  {% if selected_recipes %}
  <div class="mt-6">
    <h3 class="font-semibold mb-2">Planned Meals</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      {% for meal_type, r in selected_recipes %}
      <div class="border rounded-lg overflow-hidden card">
        {% if r.images %}
        <img src="{{ r.images[0].url }}" class="w-full h-32 object-cover">
        {% endif %}
        <div class="p-3">
          <div class="text-xs text-gray-500 capitalize">{{ meal_type }}</div>
          <div class="font-semibold">{{ r.name }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Recipe Modal -->
<div id="recipe-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 w-full max-w-3xl max-h-full overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Select a Recipe</h2>
      <button class="text-gray-500 hover:text-gray-700" onclick="closeModal()">&times;</button>
    </div>
    <div class="mb-4">
      <input type="text" id="recipe-search" placeholder="Search recipes..." class="w-full border p-2 rounded">
    </div>
    <div id="recipe-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      {% for r in recipes %}
      <div class="border rounded-lg overflow-hidden card recipe-card" data-recipe-id="{{ r.id }}" data-recipe-name="{{ r.name }}">
        {% if r.images %}
        <img src="{{ r.images[0].url }}" class="w-full h-32 object-cover">
        {% endif %}
        <div class="p-3">
          <div class="font-semibold">{{ r.name }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  let currentMealType = null;

  function openModal(mealType) {
    currentMealType = mealType;
    document.getElementById('recipe-modal').classList.remove('hidden');
  }

  function closeModal() {
    document.getElementById('recipe-modal').classList.add('hidden');
  }

  document.getElementById('recipe-search').addEventListener('keyup', function() {
    const filter = this.value.toLowerCase();
    const recipeCards = document.querySelectorAll('.recipe-card');
    recipeCards.forEach(card => {
      const name = card.dataset.recipeName.toLowerCase();
      if (name.includes(filter)) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });
  });

  document.querySelectorAll('.recipe-card').forEach(card => {
    card.addEventListener('click', function() {
      const recipeId = this.dataset.recipeId;
      document.getElementById(currentMealType + '_recipe_id').value = recipeId;
      closeModal();
    });
  });
</script>
{% endblock %}
